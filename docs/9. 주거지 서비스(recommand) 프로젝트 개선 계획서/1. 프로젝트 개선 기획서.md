# Phase 2: 추천 엔진 비즈니스 로직 설계

## 1. 현재 상태 분석

### 1.1 기존 비즈니스 로직의 한계
| 현재 로직 | 문제점 | 비즈니스 영향 |
|-----------|--------|---------------|
| `if (safe_score > cvt_score)` | 단순 이분법적 판단 | 사용자 니즈의 미세한 차이 반영 불가 |
| `ORDER BY safe_score DESC` | 단일 기준 정렬 | 복합적 선호도 무시 |
| 정적 3개 결과 반환 | 고정된 추천 개수 | 사용자별 상황 고려 부족 |
| 추천 근거 부재 | 블랙박스 추천 | 사용자 신뢰도 저하 |

### 1.2 개선 목표
**핵심 질문**: "사용자는 왜 이 지역을 선택해야 하는가?"
- 개인별 맞춤 추천
- 투명한 추천 근거
- 상황별 유연한 결과 제공

---

## 2. 새로운 비즈니스 로직 설계 (하이브리드 접근법)

### 2.1 2단계 폴백 시스템 Flow Chart

```
사용자 입력 (예산, 평수, 지역, 우선순위 패턴)
         ↓
1단계: 기본 조건으로 매물 검색
         ↓
    매물 충분(3개 이상)?
         ↓
    YES → 우선순위별 점수 계산 후 랭킹
         ↓
가격우선형: 가성비 점수 우선
안전우선형: 안전도 점수 우선  
평수우선형: 공간효율 점수 우선
         ↓
"이 매물을 추천하는 이유" 근거 생성
         ↓
    NO → 2단계: 우선순위별 경계 확장
         ↓
가격우선형: 예산유연성% → 안전임계값 완화 → 평수임계값 완화
안전우선형: 예산초과허용% → 평수타협 → 지역 확장
평수우선형: 절대최소평수 유지 → 예산초과허용% → 위치타협
         ↓
확장된 조건으로 재검색 → 우선순위 점수 계산
         ↓
"확장 조건 적용" 안내 메시지와 함께 결과 반환
```

### 2.2 핵심 비즈니스 규칙

| 단계 | 목적 | 구현 방식 | 백엔드 기술 포인트 |
|------|------|-----------|-------------------|
| **1단계: 기본 매물 확보** | 사용자 기본 조건 만족 매물 검색 | 예산+평수+지역+건물유형 필터링 | 기본 WHERE 조건, 인덱스 활용 |
| **우선순위 점수 계산** | 동일 후보군에서 우선순위별 랭킹 | 가중치 기반 점수 산출 시스템 | 정규화 점수 계산, 가중치 적용 |
| **2단계: 경계 확장** | 매물 부족 시 우선순위별 최소 양보선 적용 | 우선순위 패턴별 조건 완화 순서 | 동적 쿼리 생성, 조건부 확장 로직 |
| **추천 근거 생성** | 투명한 추천 이유 제공 | 우선순위별 템플릿 기반 메시지 | 템플릿 엔진, 동적 메시지 생성 |

---

## 3. 구현해야 할 핵심 기능

### 3.1 사용자 입력 데이터 처리 (2단계 폴백 시스템 기반)

| 기능 | 입력 | 출력 | 백엔드 기술 도전 |
|------|------|------|-----------------|
| **공통 기본 조건 처리** | 예산범위 + 평수범위 + 지역구 + 건물유형 + 임대유형 | 기본 검색조건 객체 | 기본 필터링 조건 검증, 범위 유효성 체크 |
| **우선순위 유형 선택** | 사용자 선택 (가격우선/안전우선/평수우선 중 1개) | 선택된 우선순위 타입 | enum 처리, 우선순위별 분기 로직 |
| **가격우선형 확장 조건** | 예산유연성% + 안전최소임계값 + 평수최소임계값 | 가격우선 확장조건 객체 | 유연성 비율 계산, 단계별 완화 로직 |
| **안전우선형 확장 조건** | 안전중요요소 + 최소안전점수 + 예산초과허용% + 평수타협여부 | 안전우선 확장조건 객체 | 다중선택 처리, 타협 조건 우선순위 |
| **평수우선형 확장 조건** | 절대최소평수 + 이상적평수 + 방구조선호 + 예산초과허용% + 위치타협여부 | 평수우선 확장조건 객체 | 절대조건 vs 타협조건 분리 처리 |

#### 3.1.1 2단계 폴백 시스템 상세 설계

**1단계: 기본 조건 매물 확보**
```java
// 모든 우선순위 공통 기본 조건
public class BasicSearchCondition {
    private int minBudget;           // 최소 예산
    private int maxBudget;           // 최대 예산  
    private int minArea;             // 최소 평수
    private int maxArea;             // 최대 평수
    private String district;         // 지역구
    private String propertyType;     // 건물유형
    private String rentalType;       // 임대유형 (전세/월세)
}
```

**2단계: 우선순위별 확장 조건**
```java
// 가격우선형 확장 전략
public class PricePriorityExpansion {
    private int budgetFlexibility;      // 예산 유연성 % (1순위 완화)
    private int safetyMinThreshold;     // 안전 최소 임계값 (2순위 완화) 
    private int areaMinThreshold;       // 평수 최소 임계값 (3순위 완화)
    
    // 확장 순서: 예산 → 안전 기준 → 평수 기준
}

// 안전우선형 확장 전략  
public class SafetyPriorityExpansion {
    private List<String> safetyFactors;    // 안전 중요 요소 (유지)
    private int minSafetyScore;            // 최소 안전 점수 (절대 유지)
    private int budgetExceedAllowed;       // 예산 초과 허용 % (1순위 완화)
    private boolean areaCompromiseOk;      // 평수 타협 여부 (2순위 완화)
    private boolean locationExpansionOk;   // 인접 지역 확장 (3순위 완화)
    
    // 확장 순서: 예산 → 평수 → 지역, 안전 기준은 절대 유지
}

// 평수우선형 확장 전략
public class AreaPriorityExpansion {  
    private int absoluteMinArea;           // 절대 최소 평수 (절대 유지)
    private int idealArea;                 // 이상적 평수
    private String roomStructure;          // 방 구조 선호 (유지 선호)
    private int budgetExceedAllowed;       // 예산 초과 허용 % (1순위 완화)
    private boolean locationCompromiseOk;  // 위치 타협 여부 (2순위 완화)
    
    // 확장 순서: 예산 → 위치, 절대최소평수는 절대 유지
}
```

**우선순위별 확장 로직 차별화**
```java
public class TwoPhaseRecommendService {
    
    public List<PropertyRecommendation> getRecommendations(UserInputRequest request) {
        
        // 1단계: 기본 조건으로 매물 검색
        List<Property> baseCandidates = findBasicMatches(request.getBasicCondition());
        
        if (baseCandidates.size() >= MIN_RECOMMENDATION_COUNT) {
            // 충분한 매물 → 우선순위 점수 계산
            return calculatePriorityScores(baseCandidates, request.getPriorityType());
        } else {
            // 매물 부족 → 우선순위별 경계 확장
            return expandSearchByPriority(request);
        }
    }
    
    private List<PropertyRecommendation> expandSearchByPriority(UserInputRequest request) {
        switch(request.getPriorityType()) {
            case PRICE_PRIORITY:
                return expandForPriceUsers(request);    // 예산→안전→평수 순 완화
            case SAFETY_PRIORITY:
                return expandForSafetyUsers(request);   // 예산→평수→지역 순 완화 (안전 유지)
            case AREA_PRIORITY:
                return expandForAreaUsers(request);     // 예산→위치 순 완화 (절대평수 유지)
        }
    }
}
```

### 3.2 우선순위별 점수 계산 시스템

| 기능 | 입력 | 출력 | 백엔드 기술 도전 |
|------|------|------|-----------------|
| **가격우선 점수 계산** | 매물 목록 + 가격우선 가중치 | 가성비 점수 기반 랭킹 | 가격 대비 가치 계산, 주변 시세 비교 분석 |
| **안전우선 점수 계산** | 매물 목록 + 안전우선 가중치 | 안전도 점수 기반 랭킹 | 복합 안전 지표 통합, 지역별 안전 등급 |
| **평수우선 점수 계산** | 매물 목록 + 평수우선 가중치 | 공간효율 점수 기반 랭킹 | 평당 효율성, 구조별 활용도 점수 |
| **추천 근거 생성** | 점수 계산 결과 + 우선순위 타입 | 개인화된 추천 이유 | 템플릿 기반 동적 메시지, 우선순위별 근거 |
| **확장 조건 안내** | 적용된 확장 조건 + 원본 조건 | 확장 적용 안내 메시지 | 변경사항 추적, 사용자 친화적 설명 |

### 3.3 매물 부족 시 확장 검색 시스템

| 기능 | 입력 | 출력 | 백엔드 기술 도전 |
|------|------|------|-----------------|
| **가격우선형 확장 검색** | 기본조건 + 가격우선 확장조건 | 확장된 매물 목록 | 단계별 조건 완화, 확장 범위 최적화 |
| **안전우선형 확장 검색** | 기본조건 + 안전우선 확장조건 | 안전 기준 유지한 확장 매물 | 안전 점수 절대 유지, 다른 조건 순차 완화 |
| **평수우선형 확장 검색** | 기본조건 + 평수우선 확장조건 | 절대평수 유지한 확장 매물 | 절대 조건 vs 타협 조건 분리 처리 |
| **확장 단계별 로깅** | 각 확장 단계 + 매물 발견 수 | 확장 과정 추적 데이터 | 확장 과정 모니터링, 성능 최적화 포인트 |
| **최적 확장 범위 계산** | 사용자 조건 + 지역 매물 현황 | 권장 확장 범위 | 지역별 매물 밀도 분석, 적정 확장폭 계산 |

---

## 4. 기술 스택 선택 및 근거

### 4.1 성능 관련 기술

| 문제 상황 | 선택 기술 | 선택 근거 | 예상 성능 개선 |
|-----------|-----------|-----------|----------------|
| 2단계 검색으로 인한 응답 지연 | **Redis 캐싱** | 기본 조건 결과 캐싱 + 확장 조건 결과 캐싱 | 700ms → 150ms |
| 우선순위별 점수 계산 부하 | **점수 사전 계산** | 매물별 우선순위 점수 미리 계산 후 저장 | 실시간 계산 불필요 |
| 확장 검색 시 DB 부하 | **단계별 쿼리 최적화** | 확장 단계별 인덱스 활용 + 부분 결과 재사용 | 복합 쿼리 성능 50% 개선 |

---

## 5. 예상 문제점 및 해결 전략

### 5.1 2단계 폴백 시스템 관련 문제

| 문제 | 발생 시점 | 원인 | 해결 방안 | 측정 지표 |
|------|-----------|------|-----------|-----------|
| **확장 검색 무한 루프** | 매물이 극도로 부족한 지역 | 확장해도 매물 0개 상황 | 최대 확장 범위 제한 + 대안 지역 제안 | 확장 단계 3회 제한 |
| **우선순위 점수 편향** | 특정 우선순위에서 점수 쏠림 | 정규화 기준 부적절 | 동적 정규화 + 지역별 기준 조정 | 점수 분포 표준편차 모니터링 |
| **확장 조건 사용자 혼란** | 원본 조건과 다른 결과 | 확장 적용 안내 부족 | 명확한 확장 사유 + 변경사항 하이라이트 | 사용자 만족도 설문 |

### 5.2 성능 및 확장성 문제

| 문제 | 발생 시점 | 원인 | 해결 방안 | 검증 방법 |
|------|-----------|------|-----------|-----------|
| **2단계 검색 지연** | 동시 사용자 증가 시 | 순차적 검색 + 점수 계산 | 비동기 처리 + 병렬 점수 계산 | 평균 응답시간 200ms 이하 |
| **확장 검색 메모리 사용량** | 확장 범위 증가 시 | 대량 매물 데이터 로딩 | 페이징 + 스트림 처리 | 메모리 사용률 80% 이하 |
| **우선순위별 캐시 복잡도** | 캐시 키 조합 폭증 | 기본조건×확장조건×우선순위 조합 | 계층적 캐시 구조 + TTL 차등 적용 | 캐시 히트율 85% 이상 |

---

## 6. 구현 우선순위 및 검증 계획

### 6.1 구현 순서 (중요도 순)

| 순위 | 기능 | 소요 시간 | 검증 방법 | 완료 기준 |
|------|------|-----------|-----------|-----------|
| **1순위** | 기본 조건 필터링 + 우선순위 점수 계산 | 3일 | 동일 후보군에서 우선순위별 다른 랭킹 | 3가지 우선순위별 명확한 결과 차이 |
| **2순위** | 부동산 API 연동 + 실제 매물 데이터 | 2일 | 실제 매물 데이터로 추천 테스트 | API 응답 파싱 + 매물 표시 완료 |
| **3순위** | 2단계 확장 검색 시스템 | 4일 | 매물 부족 시나리오 테스트 | 확장 조건별 추가 매물 발견 |
| **4순위** | 추천 근거 생성 + 확장 안내 | 2일 | 사용자 친화적 메시지 검증 | 명확한 추천 이유 + 확장 설명 |
| **5순위** | 성능 최적화 + 캐싱 | 3일 | 응답시간 + 동시사용자 테스트 | 200ms 이하 응답 + 100명 동시접속 |

### 6.2 핵심 성과 지표 (KPI)

| 지표 | 현재 상태 | 목표 | 측정 방법 |
|------|-----------|------|-----------|
| **매물 검색 정확도** | 조건 무시한 단순 결과 | 2단계 시스템으로 100% 결과 확보 | 기본조건 만족률 + 확장조건 적용률 |
| **우선순위별 결과 차별화** | 동일한 정렬 결과 | 우선순위별 명확히 다른 랭킹 | 3가지 우선순위 결과 중복도 30% 이하 |
| **매물 부족 상황 해결률** | 매물 0개 시 실패 | 확장 검색으로 최소 3개 확보 | 확장 검색 성공률 90% 이상 |
| **추천 근거 투명성** | 추천 이유 없음 | 모든 추천에 명확한 근거 제공 | 근거 메시지 생성률 100% |
| **응답 속도** | 평균 500ms | 평균 200ms 이하 | 2단계 검색 포함 전체 응답시간 |

---

## 7. 추후 개선 사항 (Phase 3 이후)

### 7.1 지능형 확장 전략 (장기 과제)

| 기능 | 예상 소요 시간 | 필요 기술 | 비고 |
|------|---------------|-----------|------|
| **사용자 패턴 기반 확장** | 3-4주 | 행동 패턴 분석, 협업 필터링 | 개인별 최적 확장 전략 |