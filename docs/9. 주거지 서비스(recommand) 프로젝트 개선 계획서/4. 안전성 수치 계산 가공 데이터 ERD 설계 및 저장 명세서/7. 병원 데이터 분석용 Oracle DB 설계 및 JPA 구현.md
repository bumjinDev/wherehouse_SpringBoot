# 병원 데이터 분석용 Oracle DB 설계 및 JPA 구현

**프로젝트명:** 안전성 점수 계산 시스템 - 병원 분석 데이터 처리  
**버전:** 1.0  
**작성일:** 2025.08.31  
**목적:** 기존 병원 원본 데이터에서 필요한 컬럼만 선별하여 피어슨 상관분석에 활용하기 위한 분석용 테이블 구축

---

## 프로젝트 개요

### 데이터 처리 목표
기존 `HOSPITAL_INFO` 테이블에서 분석에 필요한 병원명, 종별명, 시도명, 시군구명, 주소, 경도, 위도 정보만 선별하여 분석 전용 테이블 `ANALYSIS_HOSPITAL_STATISTICS`로 구축한다.

### 핵심 특징
- **필수 컬럼만 선별**: 7개 핵심 컬럼만 복사 (YADM_NM, CL_CD_NM, SIDO_CD_NM, SGGU_CD_NM, ADDR, X_POS, Y_POS)
- **직관적 컬럼명 적용**: 의미를 명확히 하는 컬럼명으로 변경
- **분석 전용 설계**: 제약조건 없이 순수 분석 목적의 테이블 구조
- **좌표 정보 보존**: 기존 X_POS(경도), Y_POS(위도) 데이터 그대로 유지

---

## 1. Oracle 테이블 DDL

**목적**: 분석 전용 병원 테이블 생성 및 시퀀스 설정
**역할**: 피어슨 상관분석에 사용될 독립변수(병원 밀도) 데이터 저장소 구축

```sql
-- 기존 테이블과 데이터를 완전히 삭제
DROP TABLE ANALYSIS_HOSPITAL_STATISTICS CASCADE CONSTRAINTS PURGE;
DROP SEQUENCE SEQ_ANALYSIS_HOSPITAL_STATISTICS;

-- 분석용 병원 통계 테이블 생성
CREATE TABLE ANALYSIS_HOSPITAL_STATISTICS (
    ID                      NUMBER,                     -- 제한 없음
    HOSPITAL_NAME           VARCHAR2(4000),             -- 병원명 (YADM_NM)
    HOSPITAL_TYPE           VARCHAR2(4000),             -- 종별명 (CL_CD_NM)
    SIDO_NAME               VARCHAR2(4000),             -- 시도명 (SIDO_CD_NM)
    DISTRICT_NAME           VARCHAR2(4000),             -- 시군구명 (SGGU_CD_NM)
    ADDRESS                 VARCHAR2(4000),             -- 주소 (ADDR)
    LONGITUDE               NUMBER,                     -- 경도 (X_POS)
    LATITUDE                NUMBER                      -- 위도 (Y_POS)
);

-- 시퀀스 생성
CREATE SEQUENCE SEQ_ANALYSIS_HOSPITAL_STATISTICS 
    START WITH 1 
    INCREMENT BY 1 
    NOCACHE
    NOCYCLE;

-- 확인
DESC ANALYSIS_HOSPITAL_STATISTICS;
SELECT COUNT(*) FROM ANALYSIS_HOSPITAL_STATISTICS;
```

## 2. JPA Entity

**목적**: 분석용 병원 테이블과 Java 객체 간 ORM 매핑
**역할**: 데이터베이스 CRUD 작업을 위한 엔티티 클래스 정의

```java
package com.WhereHouse.AnalysisData.hospital.entity;

import jakarta.persistence.*;
import lombok.AllArgsConstructor;
import lombok.Builder;
import lombok.Data;
import lombok.NoArgsConstructor;
import java.math.BigDecimal;

@Entity
@Table(name = "ANALYSIS_HOSPITAL_STATISTICS")
@Data
@NoArgsConstructor
@AllArgsConstructor
@Builder
public class AnalysisHospitalStatistics {

    @Id
    @GeneratedValue(strategy = GenerationType.SEQUENCE, generator = "analysis_hospital_seq")
    @SequenceGenerator(name = "analysis_hospital_seq", sequenceName = "SEQ_ANALYSIS_HOSPITAL_STATISTICS", allocationSize = 1)
    @Column(name = "ID")
    private Long id;

    @Column(name = "HOSPITAL_NAME")
    private String hospitalName;

    @Column(name = "HOSPITAL_TYPE")
    private String hospitalType;

    @Column(name = "SIDO_NAME")
    private String sidoName;

    @Column(name = "DISTRICT_NAME")
    private String districtName;

    @Column(name = "ADDRESS")
    private String address;

    @Column(name = "LONGITUDE")
    private BigDecimal longitude;

    @Column(name = "LATITUDE")
    private BigDecimal latitude;
}
```

## 3. Repository

**목적**: 분석용 병원 데이터에 대한 데이터 접근 계층 구현
**역할**: JPA 기반 CRUD 연산 및 맞춤형 쿼리 메서드 제공 (구별 병원 개수 조회, 데이터 검증용)

```java
package com.WhereHouse.AnalysisData.hospital.repository;

import com.WhereHouse.AnalysisData.hospital.entity.AnalysisHospitalStatistics;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.Query;
import org.springframework.stereotype.Repository;
import java.util.List;
import java.util.Optional;

@Repository
public interface AnalysisHospitalRepository extends JpaRepository<AnalysisHospitalStatistics, Long> {
    
    // 기본 CRUD는 JpaRepository가 제공
    
    // 데이터 검증용 커스텀 쿼리
    @Query("SELECT COUNT(a) FROM AnalysisHospitalStatistics a")
    long countAnalysisData();
    
    // 구별 병원 개수 조회 (피어슨 상관분석용)
    @Query("SELECT a.districtName, COUNT(a) FROM AnalysisHospitalStatistics a GROUP BY a.districtName ORDER BY COUNT(a) DESC")
    List<Object[]> findHospitalCountByDistrict();
    
    // 특정 구의 병원 목록 조회
    List<AnalysisHospitalStatistics> findByDistrictName(String districtName);
    
    // 병원명으로 중복 확인
    boolean existsByHospitalNameAndAddress(String hospitalName, String address);
}
```

## 4. 병원 데이터 분석용 처리 Component

**목적**: 원본 병원 데이터에서 필요한 컬럼만 선별하여 분석용 테이블로 변환하는 비즈니스 로직 처리
**역할**: 
- 기존 `HOSPITAL_INFO` 테이블에서 7개 핵심 컬럼만 조회
- 컬럼명을 직관적인 이름으로 변경하여 저장
- 데이터 품질 검증 및 구별 병원 개수 통계 로깅

```java
package com.WhereHouse.AnalysisData.hospital.processor;

import com.WhereHouse.AnalysisData.hospital.entity.AnalysisHospitalStatistics;
import com.WhereHouse.AnalysisData.hospital.repository.AnalysisHospitalRepository;
// 원본 데이터 접근을 위한 기존 패키지 import
import com.wherehouse.safety.entity.HospitalInfo;
import com.wherehouse.safety.repository.HospitalInfoRepository;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Component;
import org.springframework.transaction.annotation.Transactional;

import java.util.List;

/**
 * 병원 데이터 분석용 테이블 생성 처리 컴포넌트
 * 
 * 기존 HOSPITAL_INFO 테이블에서 데이터를 조회하여
 * 분석에 필요한 7개 컬럼만 선별하여
 * 분석 전용 ANALYSIS_HOSPITAL_STATISTICS 테이블로 저장하는 작업을 수행한다.
 * 
 * 주요 기능:
 * - 원본 병원 데이터 조회 및 검증
 * - 필수 컬럼만 선별하여 직관적인 컬럼명으로 변경
 * - 분석용 테이블 데이터 품질 검증
 * - 구별 병원 개수 통계 로깅
 * 
 * @author Safety Analysis System
 * @since 1.0
 */
@Component
@RequiredArgsConstructor
@Slf4j
public class HospitalDataProcessor {

    // 원본 병원 테이블 접근을 위한 Repository
    private final HospitalInfoRepository originalHospitalRepository;
    
    // 분석용 병원 테이블 접근을 위한 Repository  
    private final AnalysisHospitalRepository analysisHospitalRepository;

    /**
     * 병원 데이터 분석용 테이블 생성 메인 프로세스
     * 
     * 작업 순서:
     * 1. 기존 분석용 데이터 존재 여부 확인
     * 2. 원본 병원 데이터 조회 및 검증
     * 3. 필요한 7개 컬럼만 선별하여 변환
     * 4. 분석용 테이블에 저장
     * 5. 데이터 품질 검증 및 결과 로깅
     */
    @Transactional
    public void processAnalysisHospitalData() {
        log.info("=== 병원 데이터 분석용 테이블 생성 작업 시작 ===");
        
        // Step 1: 기존 분석용 데이터 중복 처리 방지를 위한 존재 여부 확인
        long existingAnalysisDataCount = analysisHospitalRepository.count();
        if (existingAnalysisDataCount > 0) {
            log.info("분석용 병원 데이터가 이미 존재합니다 (총 {} 개). 작업을 스킵합니다.", existingAnalysisDataCount);
            return;
        }

        // Step 2: 원본 병원 데이터 조회 및 검증
        List<HospitalInfo> originalHospitalDataList = originalHospitalRepository.findAll();
        if (originalHospitalDataList.isEmpty()) {
            log.warn("원본 병원 데이터가 존재하지 않습니다. 먼저 HospitalDataLoader를 통해 API 데이터를 로드해주세요.");
            return;
        }
        
        log.info("원본 병원 데이터 {} 개 발견", originalHospitalDataList.size());

        // Step 3: 데이터 변환 및 저장 작업 수행
        int successfulConversionCount = 0;  // 성공적으로 변환된 데이터 개수
        int failedConversionCount = 0;      // 변환 실패한 데이터 개수

        for (HospitalInfo originalHospitalData : originalHospitalDataList) {
            try {
                // 진행률 출력 (100개마다)
                if ((successfulConversionCount + failedConversionCount) % 100 == 0) {
                    double progress = ((double)(successfulConversionCount + failedConversionCount) / originalHospitalDataList.size()) * 100;
                    log.info("진행률: {:.1f}% ({}/{})", progress, 
                        successfulConversionCount + failedConversionCount, originalHospitalDataList.size());
                }
                
                // 원본 데이터를 분석용 엔티티로 변환 (7개 컬럼만 선별)
                AnalysisHospitalStatistics analysisTargetHospitalData = convertToAnalysisEntity(originalHospitalData);
                
                // 분석용 테이블에 데이터 저장
                analysisHospitalRepository.save(analysisTargetHospitalData);
                successfulConversionCount++;
                
                log.debug("분석용 데이터 생성 완료: {} (구: {}, 종별: {})", 
                    originalHospitalData.getYadmNm(), 
                    analysisTargetHospitalData.getDistrictName(),
                    analysisTargetHospitalData.getHospitalType());

            } catch (Exception dataConversionException) {
                log.error("분석용 데이터 생성 실패 - 병원명: {}, 오류: {}", 
                    originalHospitalData.getYadmNm(), dataConversionException.getMessage());
                failedConversionCount++;
            }
        }

        // Step 4: 변환 작업 결과 로깅
        log.info("병원 데이터 분석용 테이블 생성 작업 완료 - 성공: {} 개, 실패: {} 개", 
            successfulConversionCount, failedConversionCount);
        
        // Step 5: 최종 데이터 검증 및 품질 확인
        performFinalDataValidation();
        
        log.info("=== 병원 데이터 분석용 테이블 생성 작업 종료 ===");
    }
    
    /**
     * 원본 병원 데이터에서 필요한 7개 컬럼만 선별하여 분석용 엔티티로 변환
     * 
     * 선별 컬럼:
     * - YADM_NM → HOSPITAL_NAME (병원명)
     * - CL_CD_NM → HOSPITAL_TYPE (종별명: 종합병원 등)
     * - SIDO_CD_NM → SIDO_NAME (시도명: 서울)
     * - SGGU_CD_NM → DISTRICT_NAME (시군구명: 강남구, 종로구 등)
     * - ADDR → ADDRESS (주소)
     * - X_POS → LONGITUDE (경도)
     * - Y_POS → LATITUDE (위도)
     * 
     * @param originalHospitalData 원본 병원 데이터 엔티티
     * @return 필요한 컬럼만 포함된 분석용 병원 엔티티
     */
    private AnalysisHospitalStatistics convertToAnalysisEntity(HospitalInfo originalHospitalData) {
        return AnalysisHospitalStatistics.builder()
            .hospitalName(originalHospitalData.getYadmNm())           // 병원명
            .hospitalType(originalHospitalData.getClCdNm())           // 종별명 (종합병원 등)
            .sidoName(originalHospitalData.getSidoCdNm())             // 시도명 (서울)
            .districtName(originalHospitalData.getSgguCdNm())         // 시군구명 (강남구 등)
            .address(originalHospitalData.getAddr())                  // 주소
            .longitude(originalHospitalData.getXPos())                // 경도
            .latitude(originalHospitalData.getYPos())                 // 위도
            .build();
    }
    
    /**
     * 분석용 데이터의 최종 검증 및 품질 확인
     * 
     * 작업 내용:
     * - 전체 데이터 개수 확인
     * - 구별 병원 개수 상위 5개 로깅
     * - 데이터 검증 과정에서 발생하는 오류 처리
     */
    private void performFinalDataValidation() {
        try {
            // 최종 저장된 분석용 데이터 개수 확인
            long finalAnalysisDataCount = analysisHospitalRepository.count();
            log.info("최종 분석용 병원 데이터 저장 완료: {} 개", finalAnalysisDataCount);
            
            // 구별 병원 개수 조회 및 로깅 (피어슨 상관분석 검증용)
            List<Object[]> districtHospitalCountList = analysisHospitalRepository.findHospitalCountByDistrict();
            log.info("서울시 구별 병원 개수 순위 (상위 5개구):");
            
            districtHospitalCountList.stream()
                .limit(5)
                .forEach(rankingRow -> {
                    String districtName = (String) rankingRow[0];    // 구 이름
                    Long hospitalCount = (Long) rankingRow[1];       // 병원 개수
                    log.info("  {} : {} 개", districtName, hospitalCount);
                });
                
        } catch (Exception dataValidationException) {
            log.error("분석용 데이터 검증 과정에서 오류가 발생했습니다: {}", 
                dataValidationException.getMessage(), dataValidationException);
        }
    }
}
```

## 5. Main 처리 클래스 연동

**목적**: 전체 분석용 데이터 처리 작업에 병원 프로세서 추가
**역할**: 기존 Main 클래스에 병원 데이터 처리 프로세서 연동

```java
package com.WhereHouse.AnalysisData.main;

import com.WhereHouse.AnalysisData.crime.processor.CrimeDataProcessor;
import com.WhereHouse.AnalysisData.streetlight.processor.StreetlightDataProcessor;
import com.WhereHouse.AnalysisData.hospital.processor.HospitalDataProcessor;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.boot.CommandLineRunner;
import org.springframework.stereotype.Component;

@Component
@RequiredArgsConstructor
@Slf4j
public class AnalysisDataProcessor implements CommandLineRunner {

    private final CrimeDataProcessor crimeDataProcessor;
    private final StreetlightDataProcessor streetlightDataProcessor;
    private final HospitalDataProcessor hospitalDataProcessor;
    // 향후 16개 ERD별 프로세서 추가 예정

    @Override
    public void run(String... args) throws Exception {
        log.info("=== 안전성 분석용 데이터 처리 시작 ===");
        
        try {
            // 1. 범죄 데이터 처리
            log.info("1. 범죄 데이터 분석용 테이블 생성 시작");
            crimeDataProcessor.processAnalysisCrimeData();
            
            // 2. 가로등 데이터 처리
            log.info("2. 가로등 데이터 분석용 테이블 생성 시작");
            streetlightDataProcessor.processAnalysisStreetlightData();
            
            // 3. 병원 데이터 처리
            log.info("3. 병원 데이터 분석용 테이블 생성 시작");
            hospitalDataProcessor.processAnalysisHospitalData();
            
            // 향후 추가될 16개 ERD별 데이터 처리
            // 4. CCTV 데이터 처리
            // log.info("4. CCTV 데이터 분석용 테이블 생성 시작");
            // cctvDataProcessor.processAnalysisCctvData();
            
            // ... 추가 프로세서들
            
        } catch (Exception e) {
            log.error("안전성 분석용 데이터 처리 중 오류 발생", e);
            throw e;
        }
        
        log.info("=== 안전성 분석용 데이터 처리 완료 ===");
    }
}
```

## 실행 방법 및 검증

### 1. 데이터베이스 설정
1. Oracle DB에 DDL 스크립트 실행
2. 테이블 생성 및 시퀀스 확인

### 2. 애플리케이션 실행
```bash
./gradlew bootRun
```

### 3. 실행 결과 검증
```sql
-- 데이터 개수 확인
SELECT COUNT(*) FROM ANALYSIS_HOSPITAL_STATISTICS;

-- 구별 병원 개수 확인
SELECT DISTRICT_NAME, COUNT(*) as HOSPITAL_COUNT 
FROM ANALYSIS_HOSPITAL_STATISTICS 
GROUP BY DISTRICT_NAME 
ORDER BY COUNT(*) DESC;

-- 병원 종별 분포 확인
SELECT HOSPITAL_TYPE, COUNT(*) as TYPE_COUNT 
FROM ANALYSIS_HOSPITAL_STATISTICS 
GROUP BY HOSPITAL_TYPE 
ORDER BY COUNT(*) DESC;

-- 원본 데이터와 분석용 데이터 개수 비교
SELECT 
    (SELECT COUNT(*) FROM HOSPITAL_INFO) as ORIGINAL_COUNT,
    (SELECT COUNT(*) FROM ANALYSIS_HOSPITAL_STATISTICS) as ANALYSIS_COUNT;
```

## 예상 처리 결과

### 로그 출력 예시
```
=== 안전성 분석용 데이터 처리 시작 ===
3. 병원 데이터 분석용 테이블 생성 시작
원본 병원 데이터 [원본데이터개수] 개 발견
진행률: 7.5% (100/[원본데이터개수])
진행률: 15.0% (200/[원본데이터개수])
...
병원 데이터 분석용 테이블 생성 작업 완료 - 성공: [성공개수] 개, 실패: [실패개수] 개
서울시 구별 병원 개수 순위 (상위 5개구):
  강남구 : [개수] 개
  종로구 : [개수] 개
  중구 : [개수] 개
  동대문구 : [개수] 개
  영등포구 : [개수] 개
=== 안전성 분석용 데이터 처리 완료 ===
```

### 데이터 품질 예상 결과
- 전체 병원 데이터: 기존 원본 테이블과 동일한 개수
- 컬럼 선별률: 100% (7개 필수 컬럼만 선별)
- 구별 데이터 분포: 25개 자치구 전체 커버

이 시스템은 향후 피어슨 상관분석에서 독립변수로 활용될 구별 병원 밀도 계산의 기초 데이터를 제공합니다.