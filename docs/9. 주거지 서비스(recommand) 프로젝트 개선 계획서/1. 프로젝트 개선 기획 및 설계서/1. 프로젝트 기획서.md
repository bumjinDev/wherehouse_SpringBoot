# 부동산 추천 엔진 비즈니스 로직 설계서

## 프로젝트 개요

**목표**: 사용자 맞춤형 부동산 추천 로직 개발  
**핵심 질문**: "사용자는 왜 이 지역을 선택해야 하는가?"  
**접근 방식**: 2단계 폴백 하이브리드 방식

---

## 현재 상태 분석

### 기존 아키텍처 분석

**컨트롤러 구조**
- `RecServiceController`: 전세(`/charter`)와 월세(`/monthly`) 요청을 별도 엔드포인트로 분리
- 각각 `RecCharterServiceRequestVO`, `RecMonthlyServiceRequestVO` 전용 DTO 사용
- Spring Validation 적용으로 입력 검증 처리

**서비스 레이어 구조**
- `RecommandCharterService`: 전세 비즈니스 로직 처리
- `RecServiceMonthlyService`: 월세 비즈니스 로직 처리  
- `RecServiceEmpRepository`: 공통 데이터 액세스 레이어

**데이터베이스 구조**
- `gu_info` 테이블 중심의 구별 기반 추천
- 컬럼: `gu_id`, `gu_name`, `cvt_score`, `safe_score`, 편의시설 개수, 가격 정보
- Oracle DB 사용 (`ROWNUM` 구문으로 확인)

### 기존 비즈니스 로직의 상세 분석

**전세 추천 로직 (RecommandCharterService)**
```java
// 조건 1: 안전 점수가 편의 점수보다 높을 때
if (safe_score > cvt_score) {
    ORDER BY safe_score DESC, charter_avg DESC
}
// 조건 2: 편의 점수가 안전 점수보다 높을 때  
else if (safe_score < cvt_score) {
    ORDER BY cvt_score DESC, charter_avg DESC
}
// 조건 3: 점수가 동일할 때
else {
    ORDER BY CASE WHEN (safe_score+1)*10 < 60 THEN charter_avg ELSE cvt_score END DESC
}
```

**월세 추천 로직 (RecServiceMonthlyService)**
```java
// 동일한 3단계 분기 구조, 단지 필터링 조건만 다름
WHERE monthly_avg <= ? AND deposit_avg <= ?
```

### 기존 로직의 구체적 문제점

| 구현 부분 | 현재 로직 | 문제점 | 비즈니스 영향 |
|-----------|-----------|--------|---------------|
| **사용자 선호도 판단** | `safe_score > cvt_score` 단순 비교 | 사용자가 직접 입력한 점수로만 판단, 실제 우선순위 의도 파악 불가 | 사용자 의도와 다른 추천 결과 |
| **추천 기준 선택** | 안전 우선 vs 편의 우선 이분법 | 가격, 평수, 교통 등 다른 요소 고려 불가 | 복합적 니즈를 가진 사용자 만족도 저하 |
| **정렬 방식** | `ORDER BY safe_score DESC` 단일 기준 | 다중 요소 종합 평가 없음 | 차별화되지 않은 획일적 결과 |
| **결과 개수** | `WHERE ROWNUM <= 3` 고정 | 매물 상황이나 사용자 요구에 관계없이 3개 고정 | 매물 부족 시 빈 결과, 매물 풍부 시 선택권 제한 |
| **매물 부족 처리** | 조건 미충족 시 빈 결과 반환 | 대안 제시나 조건 완화 로직 없음 | 서비스 실패율 증가, 사용자 이탈 |
| **추천 근거 제공** | 결과만 반환, 근거 없음 | 왜 이 지역을 추천했는지 설명 부재 | 사용자 신뢰도 저하, 의사결정 지원 부족 |
| **캐싱 및 성능** | 매번 DB 쿼리 실행 | 동일 조건 반복 검색 시 불필요한 DB 부하 | 응답 지연, 서버 자원 낭비 |

### 기존의 기술적 한계점

**데이터 모델 제약**
- 구별 단위 집계 데이터만 존재, 개별 매물 정보 부재
- 가격 정보가 평균값으로만 제공되어 실제 매물 가격 범위 파악 불가
- 편의시설과 안전 점수의 가중치나 산출 근거 불분명

**쿼리 로직 문제**
- 하드코딩된 SQL 문으로 유지보수성 저하
- 매직 넘버 사용 (`ROWNUM <= 3`, `*10 < 60`) 의미 불분명
- 조건문 중복 (`safe_score > cvt_score` 두 번 등장하는 오류)

**확장성 제약**
- 전세/월세 서비스가 거의 동일한 로직으로 중복 구현
- 새로운 우선순위 추가 시 전체 서비스 수정 필요
- 점수 계산 방식 변경 시 하드코딩된 쿼리 전체 수정 필요

### 개선 목표

**1차 목표: 로직 정교화**
- 사용자 우선순위 의도를 정확히 파악하는 입력 처리 개선
- 복합적 점수 계산을 통한 정교한 랭킹 로직 도입
- 매물 부족 상황에 대한 대응 전략 구현

**2차 목표: 성능 고도화**  
- 명확한 추천 근거 제공으로 사용자 신뢰도 향상
- 캐싱 및 성능 최적화를 통한 응답 속도 개선
- 확장 가능한 아키텍처로 리팩토링

---

## 새로운 비즈니스 로직 설계

### 2단계 폴백 방식 상세 설명

**1단계: 사용자 기본 조건 검색**
사용자가 입력한 예산, 평수, 지역, 건물 유형 등 기본 조건으로 매물을 검색한다. 이 단계에서는 모든 우선순위 유형에 대해 동일한 기본 조건을 적용한다.

**결과 판단 기준**: 검색된 매물이 3개 이상인가?

**충분한 매물 발견 시 (1단계 성공)**
동일한 매물 후보군에서 사용자의 우선순위에 따라 서로 다른 가중치를 적용하여 점수를 계산한다. 사용자가 설정한 1순위 요소를 주요 기준으로, 2순위와 3순위 요소를 보조 기준으로 활용한다.

**매물 부족 시 (2단계 확장 검색)**
사용자가 설정한 1순위, 2순위, 3순위 중요도에 따라 완화 순서를 결정한다:
- 가장 덜 중요한 조건(3순위)부터 완화
- 중간 중요도 조건(2순위)을 다음으로 완화  
- 가장 중요한 조건(1순위)은 최후에 완화하거나 절대 유지

확장 검색 후에는 새로 발견된 매물들에 대해 우선순위별 점수 계산을 적용하고, 사용자에게 "어떤 조건이 확장되었는지" 명확히 안내한다.

### 핵심 비즈니스 규칙

**기본 매물 확보 단계**
사용자가 입력한 기본 조건(예산, 평수, 지역, 건물유형)으로 WHERE 조건을 구성하여 매물을 검색한다. 모든 우선순위 유형에 대해 동일한 기본 검색 조건을 적용하여 공정한 비교 기준을 확보한다.

**우선순위별 점수 계산**
동일한 매물 후보군에서 사용자의 우선순위에 따라 가중치를 다르게 적용한다. 각 매물의 가격, 안전도, 공간효율성 점수를 우선순위별 가중치를 곱하여 최종 점수를 산출한다.

**조건 확장 단계**
기본 검색에서 충분한 매물이 발견되지 않을 경우, 우선순위 순서에 따라 덜 중요한 조건부터 완화한다. 확장 시에는 사용자의 핵심 가치는 최대한 보존하면서 차선책 조건만 완화한다.

**추천 근거 제공**
최종 추천 결과와 함께 "왜 이 매물을 추천하는지"에 대한 명확한 근거를 제공한다. 확장 검색이 적용된 경우 어떤 조건이 어느 정도 완화되었는지도 함께 안내한다.

---

## 구현해야 할 핵심 기능

### 1. 사용자 입력 데이터 처리

**공통 기본 조건**
모든 우선순위 유형에서 공통으로 적용할 기본 조건을 처리한다. 예산 범위, 평수 범위, 지역구, 건물 유형, 임대 유형(전세/월세) 등의 필수 조건을 검증하고 데이터베이스 쿼리 조건으로 변환한다.

**우선순위별 확장 조건 처리**

**사용자 우선순위 입력**
사용자로부터 1순위, 2순위, 3순위 중요도를 직접 입력받는다. 예를 들어 "가격 1순위, 안전 2순위, 평수 3순위" 또는 "안전 1순위, 평수 2순위, 가격 3순위" 형태로 우선순위를 명시적으로 설정받는다.

**확장 순서 결정 로직**
입력받은 우선순위에 따라 조건 완화 순서를 동적으로 결정한다. 3순위(가장 덜 중요한 조건)부터 먼저 완화하고, 2순위 조건을 다음으로 완화하며, 1순위(가장 중요한 조건)는 최후에 완화하거나 경우에 따라 절대 유지한다.

**완화 범위 설정**
각 조건별로 완화 가능 범위를 사용자로부터 입력받는다. 예산의 경우 유연성 비율, 안전의 경우 최소 임계값, 평수의 경우 절대 최소값과 같은 세부 설정을 통해 완화 범위를 제한한다.

### 2. 우선순위별 점수 계산 로직

**가중치 적용 방식**
동일한 매물 후보군에서 사용자의 우선순위에 따라 서로 다른 가중치를 적용한다. 사용자가 설정한 1순위 요소에는 높은 가중치를, 2순위와 3순위 요소에는 상대적으로 낮은 가중치를 적용하여 최종 점수를 산출한다.

### 3. 2단계 폴백 방식 구현

**매물 충분성 판단 로직**
기본 조건 검색에서 반환된 매물 목록이 비어있지 않은지 확인한다. 결과가 존재할 경우 우선순위 기반 점수 계산으로 진행하고, 빈 결과일 경우 조건 완화 단계를 실행한다.

**우선순위별 확장 전략 적용**
사용자의 1순위, 2순위, 3순위 설정에 따라 완화 순서를 결정한다. 가장 중요한 1순위 조건은 최대한 유지하면서 덜 중요한 조건부터 완화한다. 각 확장 단계마다 매물 개수를 확인하여 적정 선에서 확장을 중단한다.

### 4. 구 단위 집계 및 순위 결정 로직

**매물별 점수의 구별 집계**
전체 서울 25개구를 대상으로 사용자의 기본 조건(예산, 평수)에 맞는 매물이 몇 개나 있는지 확인한다. 각 구별로 해당 조건을 만족하는 매물들의 우선순위 점수를 계산하여 구별 대표 점수를 산출한다.

**구별 점수 계산 방식**
- 강남구 기준 점수 = (조건 만족 매물 수) × (해당 매물들의 평균 안전 점수)  
- 관악구 기준 점수 = (조건 만족 매물 수) × (해당 매물들의 평균 안전 점수)

**상위 3개 구 선정**
계산된 구별 점수를 기준으로 상위 3개 구를 선정한다. 예시로 "현재 조건으로는 강남구(추천 매물 12건), 서초구(추천 매물 8건), 동작구(추천 매물 5건)을 추천한다"와 같이 매물 개수와 함께 제시한다.

**선정된 구의 상세 매물 제공**
사용자가 추천된 구를 클릭하면, 해당 지역의 실제 매물 목록을 보여준다. 이를 통해 사용자가 구체적인 매물 정보를 확인할 수 있도록 한다.

---

## UI/UX 연동 방식 및 정보 표시 전략

### 2단계 정보 표시 구조

**1단계: 구 단위 추천 목록 (왼쪽 패널)**
기존의 "생활 안전 93점", "생활 편의 56점" 형태의 추상적 점수 표시 대신, 우선순위별 점수 계산 결과 상위 3개 지역구를 선별하여 각 구별로 구체적인 추천 근거 요약을 3-4줄로 표시한다.

- 가격우선 사용자 예시: "평균 전세가 1억4천만원, 인근 시세 대비 8% 저렴, 교통비 절약 가능"
- 안전우선 사용자 예시: "CCTV 밀도 높음, 경찰서 500m 거리, 야간 조명 우수"  
- 평수우선 사용자 예시: "25평대 매물 풍부"

**2단계: 매물 단위 상세 정보 (우측 패널 + 카카오 맵)**
사용자가 왼쪽 패널에서 특정 구를 선택하면 두 가지 화면 변화가 동시에 발생한다:

**우측 정보 패널 변화:**
해당 구의 매물들을 우선순위별로 점수 계산하여 상위 2개 매물의 구체적인 정보와 상세 근거를 표시한다.

**카카오 맵 화면 변화:**
- 선택된 지역구로 지도 화면이 자동 확대 및 이동
- 해당 구 내의 모든 매물 위치를 아이콘으로 지도 위에 표시
- 사용자는 지도 확대/축소 및 화면 이동으로 매물 위치 상세 탐색 가능
- 지도상 매물 아이콘 클릭 시 우측 정보 패널의 내용이 해당 개별 매물 정보로 교체되어 표시

**1순위 매물 정보:**
- 기본 정보: "2룸 1욕실, 전세 1억4천만원, 역세권 도보 3분"
- 관리 정보: "관리비 월 8만원, 주차 가능, 엘리베이터 있음"
- 상세 근거: "반경 300m 내 CCTV 15대 설치, 경찰서 500m, 24시간 편의점 3개소"

**2순위 매물 정보:**
- 기본 정보: "3룸 2욕실, 전세 1억6천만원, 버스정류장 1분"
- 관리 정보: "관리비 월 12만원, 주차 1대, 신축 5년"
- 상세 근거: "지하철 2호선 5분 거리, 대형마트 도보 3분, 초등학교 300m"

각 매물별로 사용자 우선순위(1순위, 2순위, 3순위)에 따라 계산된 점수를 기준으로 정렬하여 표시한다.

### 근거 생성 로직

**우선순위별 강조 요소**
사용자가 설정한 1순위, 2순위, 3순위에 따라 표시할 근거의 순서와 비중을 조정한다.
- 1순위 요소: 가장 상단에 굵은 글씨로 강조 표시
- 2-3순위 요소: 보조 정보로 간략히 표시

**구 단위 vs 매물 단위 정보 차별화**
- 구 단위: 해당 구의 대표적 특징과 평균적 장점을 요약
- 매물 단위: 개별 매물의 구체적 수치와 실제 거리, 개수 등 정확한 정보 제공

**확장 검색 적용 시 표시 방법**
확장 검색이 적용된 경우 변경된 조건을 명확히 표시한다.
- 원본 조건: "예산 2000만원 이하" (회색 표시)
- 확장 조건: "예산 2200만원으로 확장" (파란색 강조)
- 확장 사유: "더 많은 선택지 확보를 위해 3순위 조건 완화"

---

## 구현 기능 목록 및 상세 설계

### 핵심 구현 기능 목록

| 기능 ID | 기능명 | 설명 | 입력 | 출력 | 기술적 요구사항 |
|---------|--------|------|------|------|----------------|
| **F001** | 사용자 우선순위 입력 처리 | 1순위, 2순위, 3순위 중요도 설정 | 가격/안전/평수/교통/편의 중 선택 | 우선순위 순서 객체 | enum 타입 처리, 중복 선택 검증 |
| **F002** | 기본 조건 필터링 | 사용자 기본 조건으로 매물 검색 | 예산, 평수, 지역, 건물유형, 임대유형 | 필터링된 매물 목록 | WHERE 조건 구성, 기본 인덱스 활용 |
| **F003** | 매물 충분성 판단 | 1단계 검색 결과 개수 확인 | 매물 목록 | boolean (충분/부족) | 최소 개수 임계값 설정 |
| **F004** | 우선순위별 가중치 점수 계산 | 동일 후보군에서 우선순위 기반 점수 산출 | 매물 목록 + 우선순위 설정 | 점수별 정렬된 매물 목록 | 가중치 적용 로직 |
| **F005** | 확장 조건 순서 결정 | 우선순위에 따른 완화 순서 계산 | 1,2,3순위 설정 | 완화 순서 배열 | 우선순위 역순 정렬 로직 |
| **F006** | 단계별 조건 완화 검색 | 순서에 따라 조건을 하나씩 완화하여 재검색 | 기본 조건 + 완화 순서 | 확장된 매물 목록 | 동적 쿼리 생성, 조건부 WHERE 절 |
| **F007** | 추천 근거 메시지 생성 | 선택 이유와 확장 적용 사항 안내 | 최종 매물 + 적용된 확장 조건 | 개인화된 추천 근거 텍스트 | 템플릿 기반 메시지 생성 |
| **F008** | 확장 조건 안내 | 원본 조건 대비 변경사항 표시 | 원본 조건 + 확장된 조건 | 변경사항 하이라이트 메시지 | 조건 비교 로직, 차이점 추출 |

### 세부 기능 설계

**F001: 사용자 우선순위 입력 처리**
- 입력 방식: 가격, 안전, 평수, 교통, 편의 중에서 1순위, 2순위, 3순위 선택
- 검증 로직: 중복 선택 방지, 필수 1순위 선택 확인
- 출력 형태: `{first: "가격", second: "안전", third: "평수"}` 형태의 우선순위 객체

**F002: 기본 조건 필터링**  
- 입력 조건: 최소/최대 예산, 최소/최대 평수, 지역구, 건물유형, 임대유형
- 쿼리 구성: `WHERE charter_avg BETWEEN ? AND ? AND area BETWEEN ? AND ? AND gu_name = ?`
- 성능 고려: 가격, 평수, 지역별 복합 인덱스 활용

**F003: 매물 충분성 판단**
- 임계값: 최소 3개 매물 확보 기준
- 판단 로직: `resultList.size() >= MIN_RECOMMENDATION_COUNT`
- 분기 처리: 충족 시 F004 실행, 미충족 시 F005-F006 실행

**F004: 우선순위별 가중치 점수 계산**
- 가중치 적용: 1순위 요소 높은 비중, 2-3순위 요소 낮은 비중
- 점수 계산: 각 매물별로 우선순위에 따른 가중합 계산
- 정렬 기준: 계산된 최종 점수 내림차순

**F005: 확장 조건 순서 결정**
- 완화 순서: 3순위(덜 중요) → 2순위 → 1순위(가장 중요) 순서로 완화
- 절대 유지 조건: 특정 우선순위의 경우 1순위 조건은 절대 완화하지 않음
- 완화 범위: 사용자 설정값에 따른 완화 정도 제한

**F006: 단계별 조건 완화 검색**
- 완화 방식: 한 번에 하나의 조건만 완화하여 순차적 재검색
- 중단 조건: 충분한 매물 확보 시 즉시 중단
- 최대 시도: 3단계까지만 확장하여 무한 루프 방지

**F007: 추천 근거 메시지 생성**
- 기본 근거: "1순위 요소에서 높은 점수를 받았기 때문"
- 확장 근거: "3순위 조건을 완화하여 더 많은 선택지 확보"
- 메시지 구조: 추천 이유 + 장점 요약 + 확장 적용 사항(해당 시)

**F008: 확장 조건 안내**
- 변경사항 추출: 원본 조건과 확장 조건 비교 분석
- 표시 방식: "안전 기준 70점 → 50점으로 완화" 형태의 명확한 변경사항 표시
- 사용자 안내: 왜 해당 조건을 완화했는지에 대한 설명 포함

---

## 추후 개선 사항 (Phase 3 이후)

### 지능형 확장 전략 (장기 과제)

| 기능 | 예상 소요 시간 | 필요 기술 | 비고 |
|------|---------------|-----------|------|
| **사용자 패턴 기반 확장** | 3-4주 | 행동 패턴 분석, 협업 필터링 | 개인별 최적 확장 전략 |
| **머신러닝 기반 점수 최적화** | 4-5주 | TensorFlow, 사용자 피드백 데이터 | 점수 가중치 자동 조정 |
| **실시간 시장 분석** | 6-8주 | 부동산 시장 데이터 API, 시계열 분석 | 시장 상황 반영 추천 |

---

## 기대 효과

### 단기 효과 (2주 내)
- 안정적으로 동작하는 추천 로직 완성
- 우선순위별 차별화된 추천 결과 제공
- 매물 부족 상황 해결 방안 구현

### 장기 효과 (서비스 운영 후)
- 사용자별 추천 만족도 데이터 수집 가능
- 확장 패턴별 성공률 분석을 통한 지속적 개선
- 더 복잡한 개인화 로직으로의 자연스러운 진화

---

> **핵심 설계 철학**: "단순함 위에 지능을 더한다"  
> 기본은 단순하고 안전하게, 필요시에만 지능적 확장, 사용자에게는 투명하게 안내