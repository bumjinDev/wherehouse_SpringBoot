# Wherehouse 프로젝트

## OOM 병목 측정 2차 테스트 결과 보고서

**Slice 기반 청크 처리 적용**

**병목 ID:** 2.2.1 Application & Memory

**작성일:** 2026년 1월 31일

---

## 1. 문서 개요

본 문서는 1차 테스트에서 확인된 OOM 병목에 대한 개선안(Slice 기반 청크 처리)을 적용한 2차 테스트 결과를 기록한다. 1차 테스트의 findAll() 방식과 2차 테스트의 Slice 페이징 방식을 동일 환경에서 비교 분석하여 개선 효과를 정량적으로 검증한다.

---

## 2. 테스트 환경

### 2.1 JVM 설정

| 항목 | 설정값 | 비고 |
|------|--------|------|
| Maximum Heap (-Xmx) | 256 MB | 1차 테스트와 동일 |
| Java Version | OpenJDK 17.0.11 | - |

### 2.2 청크 설정

| 항목 | 설정값 | 비고 |
|------|--------|------|
| 청크 크기 (CHUNK_SIZE) | 10,000건 | Pageable.ofSize() |
| 전세 청크 수 | 6개 | 58,660 / 10,000 |
| 월세 청크 수 | 6개 | 56,272 / 10,000 |

### 2.3 데이터 규모

| 데이터셋 | 건수 | 비고 |
|----------|------|------|
| 전세 (PROPERTIES_CHARTER) | 58,660건 | 1차와 동일 |
| 월세 (PROPERTIES_MONTHLY) | 56,272건 | 1차와 동일 |
| 총 매물 수 | 114,932건 | - |

---

## 3. 측정 결과

### 3.1 소요시간 분석

| 측정 구간 | 소요시간 | 건수 | 청크 수 |
|-----------|----------|------|---------|
| 전세 데이터 로드 | 1,743 ms (1.74초) | 58,660건 | 6 |
| 월세 데이터 로드 | 1,810 ms (1.81초) | 56,272건 | 6 |
| 전세 Entity→DTO 변환 | 26 ms | - | - |
| 월세 Entity→DTO 변환 | 18 ms | - | - |
| 배치 전체 | 11,853 ms (11.85초) | - | - |

**단계별 집계:**

| 단계 | 소요시간 | 비율 |
|------|----------|------|
| DB 로드 (전세 + 월세) | 3,553 ms (3.55초) | 29.98% |
| Entity→DTO 변환 | 44 ms | 0.37% |
| 기타 처리 (Redis 동기화 등) | 8,256 ms (8.26초) | 69.65% |

### 3.2 청크별 처리 상세

**전세(CHARTER) 청크별 처리:**

| 청크 | 청크 크기 | 누적 건수 | 로드(ms) | 변환(ms) | 총계(ms) |
|------|-----------|-----------|----------|----------|----------|
| #0 | 10,000 | 10,000 | 254 | 5 | 259 |
| #1 | 10,000 | 20,000 | 318 | 4 | 322 |
| #2 | 10,000 | 30,000 | 273 | 2 | 275 |
| #3 | 10,000 | 40,000 | 287 | 3 | 290 |
| #4 | 10,000 | 50,000 | 329 | 9 | 338 |
| #5 | 8,660 | 58,660 | 253 | 3 | 256 |

**월세(MONTHLY) 청크별 처리:**

| 청크 | 청크 크기 | 누적 건수 | 로드(ms) | 변환(ms) | 총계(ms) |
|------|-----------|-----------|----------|----------|----------|
| #0 | 10,000 | 10,000 | 248 | 5 | 253 |
| #1 | 10,000 | 20,000 | 280 | 3 | 283 |
| #2 | 10,000 | 30,000 | 282 | 2 | 284 |
| #3 | 10,000 | 40,000 | 289 | 3 | 292 |
| #4 | 10,000 | 50,000 | 392 | 3 | 395 |
| #5 | 6,272 | 56,272 | 298 | 2 | 300 |

### 3.3 메모리 분석

VisualVM 힙 덤프 분석 결과 (청크별 스냅샷):

**PropertyCharter 청크별 메모리:**

| 청크 | Count | Retained Size | 힙 점유율 | 비고 |
|------|-------|---------------|-----------|------|
| #0 (10K) | 10,000 | 8,117,352 B (7.7 MB) | 1.3% | - |
| #1 (20K) | 20,000 | 10,730,800 B (10.2 MB) | 14.8% | - |
| #2 (30K) | 30,000 | 12,744,000 B (12.2 MB) | 16.8% | - |
| #3 (40K) | 40,000 | 14,744,000 B (14.1 MB) | 17.2% | - |
| #4 (50K) | 50,000 | 16,744,000 B (16.0 MB) | 17.6% | 피크 |
| 최종 | 58,660 | 17,219,976 B (16.4 MB) | 16.6% | - |

**PropertyMonthly 청크별 메모리:**

| 청크 | Count | Retained Size | 힙 점유율 | 비고 |
|------|-------|---------------|-----------|------|
| #0 (10K) | 10,000 | 8,356,288 B (8.0 MB) | 7.4% | - |
| #2 (30K) | 30,000 | 12,811,488 B (12.2 MB) | 9.7% | - |
| #3 (40K) | 40,000 | 14,810,896 B (14.1 MB) | 10.5% | - |
| #4 (50K) | 50,000 | 16,812,496 B (16.0 MB) | 11.1% | 피크 |
| 최종 | 56,272 | 15,267,336 B (14.6 MB) | 9.7% | - |

---

## 4. 1차 대비 비교 분석

### 4.1 소요시간 비교

| 측정 항목 | 1차 테스트 | 2차 테스트 | 차이 | 변화율 |
|-----------|-----------|-----------|------|--------|
| 전세 DB 로드 | 851 ms | 1,743 ms | +892 ms | +104.8% |
| 월세 DB 로드 | 876 ms | 1,810 ms | +934 ms | +106.6% |
| 전세 변환 | 17 ms | 26 ms | +9 ms | +52.9% |
| 월세 변환 | 12 ms | 18 ms | +6 ms | +50.0% |
| 배치 전체 | 7,248 ms | 11,853 ms | +4,605 ms | +63.5% |

### 4.2 메모리 사용량 비교

| 측정 항목 | 1차 테스트 | 2차 테스트 | 변화율 |
|-----------|-----------|-----------|--------|
| PropertyCharter Retained | 50.3 MB | 17.2 MB | -65.8% |
| PropertyMonthly Retained | 48.9 MB | 15.3 MB | -68.7% |
| 엔티티 메모리 합계 | 99.2 MB | 32.5 MB | -67.2% |
| 힙 피크 점유율 | 64.4% | 17.6% | -72.7% |

### 4.3 트레이드오프 분석

**DB 로드 시간 증가 원인:**

- Oracle OFFSET 페이징의 구조적 오버헤드: OFFSET 값 증가에 따른 스캔 범위 증가
- 청크당 약 290ms 소요 (6회 반복 = 1,740ms vs 1회 851ms)
- 네트워크 라운드트립 증가 (1회 → 6회)

**메모리 사용량 감소 효과:**

- 힙 피크 점유율 64.4% → 17.6% (약 73% 감소)
- 동시 적재 Entity 수 제한으로 GC 압박 감소
- 데이터 증가 시에도 힙 피크 일정 유지 (청크 크기에만 비례)

---

## 5. 결론

### 5.1 개선 효과 요약

| 항목 | 결과 | 평가 |
|------|------|------|
| 메모리 사용량 | 67.2% 감소 | 목표 달성 |
| 힙 피크 점유율 | 72.7% 감소 (64.4%→17.6%) | 목표 달성 |
| OOM 안전성 | 확보 (데이터 증가 대응) | 목표 달성 |
| DB 로드 시간 | 105% 증가 (페이징 오버헤드) | 예상된 트레이드오프 |
| 배치 전체 시간 | 63.5% 증가 | 허용 범위 |

### 5.2 최종 판단

Slice 기반 청크 처리 적용은 다음과 같은 이유로 유효한 개선안으로 판단된다:

1. **OOM 위험 해소:** 힙 피크 점유율이 64.4%에서 17.6%로 감소하여 안전 마진 확보
2. **확장성 확보:** 데이터가 증가해도 힙 사용량은 청크 크기에만 비례하여 OOM 발생 방지
3. **처리 시간 증가는 허용 범위:** 배치 작업 특성상 7초 → 12초 증가는 운영에 미치는 영향 미미
4. **청크 크기 튜닝 가능:** 현재 10,000건 설정은 보수적이며, 환경에 따라 조정 가능

### 5.3 향후 개선 방향

- **Keyset Pagination 적용 검토:** OFFSET 방식 대신 WHERE 조건 기반 페이징으로 DB 오버헤드 감소
- **청크 크기 최적화:** 메모리와 처리 시간의 균형점 탐색 (15,000~20,000건 테스트)
- **Redis 동기화 병목 분석:** 전체 배치 시간의 69.65%를 차지하는 Redis 처리 최적화
