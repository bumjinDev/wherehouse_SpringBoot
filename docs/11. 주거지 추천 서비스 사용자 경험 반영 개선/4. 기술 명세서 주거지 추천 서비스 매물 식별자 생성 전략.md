# 기술 명세서: 주거지 추천 서비스 매물 식별자 생성 전략

**문서 번호**: SPEC-DATA-001  
**작성 일자**: 2025-11-26  
**관련 모듈**: BatchScheduler, Property, ReviewService  
**문서 목적**: 외부 데이터 소스의 구조적 한계를 해결하고 리뷰 시스템의 데이터 영속성을 보장하기 위한 고유 식별자 생성 규칙 정의

---

## 1. 배경 및 문제 정의

### 1.1 외부 데이터 소스의 구조적 한계

국토교통부 실거래가 API는 다음의 구조적 제약을 가진다:

**고유 식별자 부재**  
매물에 대한 영속적 Primary Key를 제공하지 않는다. 시스템 내부에서 UUID를 임의 생성할 경우, 배치 실행 주기마다 ID가 재생성되어 리뷰 데이터와의 외래키 관계가 단절된다.

**데이터 휘발성**  
매물 정보는 배치 수집 시점마다 완전히 갱신된다. 이전 수집 데이터와의 연속성을 보장하는 메커니즘이 API 수준에서 제공되지 않는다.

**물리적 구분 불가**  
개인정보 보호 정책으로 인해 호수(Unit Number) 정보가 제공되지 않는다. 결과적으로 동일 건물 내 동일 층, 동일 면적의 복수 매물을 물리적으로 분리할 수 없다.

### 1.2 시스템 요구사항

**영속성(Persistence)**  
매물의 가격, 거래 상태 등 가변 속성이 변경되어도 식별자는 불변해야 한다.

**유일성(Uniqueness)**  
시스템 내부에서 논리적으로 동일한 매물에 대해 중복 레코드가 생성되어서는 안 된다.

**성능(Performance)**  
대용량 데이터 조회 및 조인 연산에서 인덱스 스캔 성능이 보장되어야 한다.

---

## 2. 식별자 생성 전략

### 2.1 설계 원칙: 논리적 해시 기반 식별자

물리적 호수 구분이 불가능한 제약 하에서, 시스템은 '매물 타입(Property Type)' 단위로 데이터를 통합 관리한다. 불변 속성들의 조합을 해싱하여 고유 식별자로 사용한다.

### 2.2 비즈니스 키 구성 요소

식별자 생성에 사용되는 불변 필드는 다음과 같다:

| 필드명 | 설명 | 예시 |
|--------|------|------|
| sggCd | 시군구 코드 | 11680 (강남구) |
| jibun | 지번 주소 | 123-4 |
| aptNm | 아파트/건물명 | 래미안그레이튼 |
| floor | 층수 | 10 |
| excluUseAr | 전용 면적 (㎡) | 84.99 |

### 2.3 ID 생성 알고리즘

위 필드를 구분자(`|`)로 연결한 문자열을 MD5 또는 SHA-256 해시 함수에 입력하여 고정 길이 문자열을 생성한다:

```
PropertyID = Hash(sggCd + "|" + jibun + "|" + aptNm + "|" + floor + "|" + excluUseAr)
```

**예시**:
```
Input:  "11680|123-4|래미안그레이튼|10|84.99"
Output: "5d41402abc4b2a76b9719d911017c592"
```

---

## 3. 기술적 타당성 분석

### 3.1 DB 인덱스 성능 최적화

**Raw 데이터 조합 방식의 문제**  
원본 필드 조합을 복합키로 사용할 경우, 키의 길이가 가변적이며 100 Byte 이상으로 증가한다. B-Tree 인덱스의 깊이가 증가하여 탐색 비용이 상승하고, 리프 노드의 분할(Split) 빈도가 높아져 쓰기 성능이 저하된다.

**해시 기반 방식의 이점**  
MD5는 항상 32자, SHA-256은 64자의 고정 길이를 가진다. 인덱스 키 크기가 일정하므로 B-Tree의 균형이 유지되고, 조회 시 비교 연산 횟수가 최소화된다. 특히 `Reviews` 테이블과의 JOIN 연산에서 인덱스 탐색 비용이 대폭 감소한다.

### 3.2 API 통신 안정성

**URL 경로 설계 문제**  
한글, 공백, 특수문자가 포함된 복합키를 URL Path Variable로 사용할 경우:
- 클라이언트 측 인코딩 불일치로 인한 요청 실패
- 서버 측 디코딩 오류로 인한 404 응답
- 로그 및 모니터링 시스템에서의 가독성 저하

**해시 ID 사용 시 개선**  
영문자와 숫자로만 구성된 해시 값은 RFC 3986의 Unreserved Characters에 해당하므로 별도 인코딩 없이 안전하게 전송된다:

```
AS-IS: /api/reviews/서울시%20강남구%20역삼동... (URL 인코딩 필요)
TO-BE: /api/reviews/5d41402abc4b2a76b9719d911017c592 (인코딩 불필요)
```

### 3.3 시스템 결합도 감소

**비즈니스 키 변경 시나리오**  
향후 요구사항 변경으로 식별자 생성 규칙이 수정될 경우(예: 면적 대신 방 개수 사용), Raw 키 방식은 DB에 저장된 모든 외래키를 물리적으로 갱신해야 하는 마이그레이션 위험이 발생한다.

**해시 방식의 유연성**  
해시 함수의 입력 규칙은 내부적으로 변경 가능하되, 출력 형태는 일관되게 유지된다. 기존 데이터의 해시 값은 불변이므로, 신규 생성 로직만 변경하면 되어 시스템 간 결합도가 낮아진다.

---

## 4. 데이터 처리 정책

### 4.1 중복 데이터 통합 전략

**시나리오**  
동일 건물, 동일 층, 동일 면적의 매물이 복수 수집되는 경우(예: 1001호와 1002호).

**처리 로직**  
두 매물의 해시 ID는 동일하게 계산된다. 시스템은 이를 단일 '매물 타입' 그룹으로 간주하여 DB에 1건만 저장(Upsert)한다.

**설계 의의**  
사용자는 특정 호수가 아닌 '해당 평형대와 층수'라는 추상화된 매물 단위에 리뷰를 작성하게 된다. 이는 리뷰 데이터의 분산을 방지하고 정보 밀집도를 높여 추천 알고리즘의 신뢰도를 향상시킨다.

### 4.2 배치 갱신 로직

BatchScheduler는 다음 절차를 따른다:

1. 외부 API로부터 매물 데이터 수집
2. 비즈니스 키 추출 및 해시 ID 생성
3. DB 조회:
   - 기존 ID 존재 시: 가격, 거래일자 등 가변 속성만 UPDATE
   - 기존 ID 부재 시: 신규 레코드 INSERT
4. 리뷰 테이블의 외래키 참조 무결성 자동 유지

---

## 5. 결론

본 명세서는 외부 데이터 소스의 구조적 한계를 해시 기반 논리적 식별자로 해결하는 아키텍처 의사결정을 기록한다. 이 전략은 데이터 영속성, 시스템 성능, API 안정성을 동시에 확보하며, 향후 비즈니스 로직 변경에 대한 유연성을 제공한다. 

모든 개발 작업은 본 문서에 정의된 ID 생성 규칙을 기준으로 수행되어야 한다.