# 리뷰 시스템 Postman 테스트 명세서

**문서 번호**: TEST-API-001  
**작성 일자**: 2025-12-02  
**Base URL**: `http://localhost:8185/wherehouse`  
**관련 코드**: ReviewWriteController.java, ReviewQueryController.java

---

## 환경 설정

### Postman Environment Variables

| Variable | Initial Value | Current Value |
|----------|---------------|---------------|
| base_url | http://localhost:8185/wherehouse | (자동 설정) |
| test_property_id | 5d41402abc4b2a76b9719d911017c592 | (자동 설정) |
| test_user_id | user_1234 | (자동 설정) |
| created_review_id | | (Tests 스크립트에서 설정) |
| updated_at | | (Tests 스크립트에서 설정) |

---

## API 명세

### 1. 리뷰 작성

**Endpoint**: `POST {{base_url}}/api/v1/reviews`

#### Headers
```
Content-Type: application/json
```

#### Request Body
```json
{
  "property_id": "{{test_property_id}}",
  "user_id": "{{test_user_id}}",
  "rating": 5,
  "content": "남향이라 채광이 정말 좋고, 관리비도 저렴한 편입니다. 역세권이라 교통도 편리해요."
}
```

#### Success Response (201 Created)
```json
{
  "review_id": 1,
  "created_at": "2025-11-27T10:30:00"
}
```

#### Error Responses

**400 Bad Request - Validation 실패**
```json
{
  "timestamp": "2025-12-02T14:30:00.123+00:00",
  "status": 400,
  "error": "Bad Request",
  "message": "Validation failed for argument [0] in public org.springframework.http.ResponseEntity<...>",
  "errors": [
    {
      "codes": ["Size.reviewCreateRequestDto.propertyId", "Size.propertyId", "Size.java.lang.String", "Size"],
      "arguments": [
        {
          "codes": ["reviewCreateRequestDto.propertyId", "propertyId"],
          "arguments": null,
          "default_message": "propertyId",
          "code": "propertyId"
        },
        32,
        32
      ],
      "default_message": "매물 ID는 32자여야 합니다",
      "object_name": "reviewCreateRequestDto",
      "field": "propertyId",
      "rejected_value": "abc123",
      "binding_failure": false,
      "code": "Size"
    }
  ],
  "path": "/api/v1/reviews"
}
```

**409 Conflict - 중복 리뷰**
```json
{
  "timestamp": "2025-12-02T14:30:00.123+00:00",
  "status": 409,
  "error": "Conflict",
  "message": "이미 해당 매물에 대한 리뷰가 존재합니다",
  "path": "/api/v1/reviews"
}
```

#### Tests Script
```javascript
// 응답 코드 검증
pm.test("Status code is 201", function () {
    pm.response.to.have.status(201);
});

// Response Body 검증
pm.test("Response has review_id", function () {
    var jsonData = pm.response.json();
    pm.expect(jsonData).to.have.property('review_id');
    pm.expect(jsonData).to.have.property('created_at');
});

// 환경변수에 review_id 저장 (후속 테스트에서 사용)
if (pm.response.code === 201) {
    var jsonData = pm.response.json();
    pm.environment.set("created_review_id", jsonData.review_id);
}
```

#### 테스트 케이스

**TC-1.1: 정상 리뷰 작성**
- Request Body: 위의 기본 예시
- Expected: 201 Created

**TC-1.2: propertyId 누락**
```json
{
  "user_id": "user_1234",
  "rating": 5,
  "content": "남향이라 채광이 정말 좋고, 관리비도 저렴한 편입니다."
}
```
- Expected: 400 Bad Request
- Error Field: `propertyId`
- Error Code: `NotBlank`

**TC-1.3: propertyId 길이 오류 (32자 미만)**
```json
{
  "property_id": "abc123",
  "user_id": "user_1234",
  "rating": 5,
  "content": "남향이라 채광이 정말 좋고, 관리비도 저렴한 편입니다."
}
```
- Expected: 400 Bad Request
- Error Field: `propertyId`
- Error Code: `Size`

**TC-1.4: rating 범위 초과 (6점)**
```json
{
  "property_id": "5d41402abc4b2a76b9719d911017c592",
  "user_id": "user_1234",
  "rating": 6,
  "content": "남향이라 채광이 정말 좋고, 관리비도 저렴한 편입니다."
}
```
- Expected: 400 Bad Request
- Error Field: `rating`
- Error Code: `Max`

**TC-1.5: rating 범위 미만 (0점)**
```json
{
  "property_id": "5d41402abc4b2a76b9719d911017c592",
  "user_id": "user_1234",
  "rating": 0,
  "content": "남향이라 채광이 정말 좋고, 관리비도 저렴한 편입니다."
}
```
- Expected: 400 Bad Request
- Error Field: `rating`
- Error Code: `Min`

**TC-1.6: content 길이 부족 (20자 미만)**
```json
{
  "property_id": "5d41402abc4b2a76b9719d911017c592",
  "user_id": "user_1234",
  "rating": 5,
  "content": "좋아요"
}
```
- Expected: 400 Bad Request
- Error Field: `content`
- Error Code: `Size`

**TC-1.7: content 길이 초과 (1000자 초과)**
```json
{
  "property_id": "5d41402abc4b2a76b9719d911017c592",
  "user_id": "user_1234",
  "rating": 5,
  "content": "매우매우매우... (1001자 이상)"
}
```
- Expected: 400 Bad Request
- Error Field: `content`
- Error Code: `Size`

**TC-1.8: 중복 리뷰 작성**
- Precondition: TC-1.1 실행 완료 (동일 propertyId + userId 리뷰 존재)
- Request Body: TC-1.1과 동일
- Expected: 409 Conflict

---

### 2. 리뷰 목록 조회

**Endpoint**: `POST {{base_url}}/api/v1/reviews/query`

#### Headers
```
Content-Type: application/json
```

#### Request Body

**케이스 A: 특정 매물 리뷰 조회 (모달용)**
```json
{
  "property_id": "{{test_property_id}}",
  "page": 1,
  "size": 10,
  "sort": "latest"
}
```

**케이스 B: 전체 리뷰 조회 (게시판용)**
```json
{
  "page": 1,
  "size": 10,
  "sort": "latest"
}
```

**케이스 C: 별점 정렬**
```json
{
  "property_id": "5d41402abc4b2a76b9719d911017c592",
  "page": 1,
  "size": 10,
  "sort": "rating_desc"
}
```
- `sort` 옵션: `latest`, `rating_desc`, `rating_asc`

#### Success Response (200 OK)

**특정 매물 조회 시**
```json
{
  "filter_meta": {
    "target_property_id": "5d41402abc4b2a76b9719d911017c592",
    "property_avg_rating": 4.5
  },
  "reviews": [
    {
      "review_id": 1,
      "property_id": "5d41402abc4b2a76b9719d911017c592",
      "property_name": "매물명",
      "user_id": "user****",
      "rating": 5,
      "summary": "남향이라 채광이 정말 좋고, 관리비도 저렴한 편입니다. 역세권이라 교통도 편리해요.",
      "tags": ["채광", "남향", "역세권", "편리"],
      "created_at": "2025-11-27T10:30:00"
    }
  ],
  "pagination": {
    "current_page": 1,
    "total_pages": 1,
    "total_items": 1,
    "page_size": 10,
    "has_next": false,
    "has_previous": false
  }
}
```

**전체 리뷰 조회 시**
```json
{
  "filter_meta": null,
  "reviews": [...],
  "pagination": {...}
}
```

#### Error Responses

**400 Bad Request - Validation 실패**
```json
{
  "timestamp": "2025-12-02T14:30:00.123+00:00",
  "status": 400,
  "error": "Bad Request",
  "message": "Validation failed",
  "errors": [
    {
      "defaultMessage": "매물 ID는 32자여야 합니다",
      "field": "propertyId",
      "rejectedValue": "abc123",
      "code": "Size"
    }
  ],
  "path": "/api/v1/reviews/query"
}
```

#### Tests Script
```javascript
pm.test("Status code is 200", function () {
    pm.response.to.have.status(200);
});

pm.test("Response structure is valid", function () {
    var jsonData = pm.response.json();
    pm.expect(jsonData).to.have.property('reviews');
    pm.expect(jsonData).to.have.property('pagination');
    pm.expect(jsonData.reviews).to.be.an('array');
});

// property_id가 요청에 포함된 경우 filter_meta 검증
var requestBody = JSON.parse(pm.request.body.raw);
if (requestBody.property_id) {
    pm.test("FilterMeta exists for property-specific query", function () {
        var jsonData = pm.response.json();
        pm.expect(jsonData.filter_meta).to.not.be.null;
        pm.expect(jsonData.filter_meta.target_property_id).to.eql(requestBody.property_id);
    });
}
```

#### 테스트 케이스

**TC-2.1: 특정 매물 리뷰 조회**
```json
{
  "property_id": "5d41402abc4b2a76b9719d911017c592",
  "page": 1,
  "size": 10,
  "sort": "latest"
}
```
- Expected: 200 OK
- filter_meta: Not null
- reviews: 해당 property_id의 리뷰만 포함

**TC-2.2: 전체 리뷰 조회**
```json
{
  "page": 1,
  "size": 10,
  "sort": "latest"
}
```
- Expected: 200 OK
- filter_meta: null
- reviews: 모든 리뷰 포함

**TC-2.3: 별점 높은순 정렬**
```json
{
  "page": 1,
  "size": 10,
  "sort": "rating_desc"
}
```
- Expected: 200 OK
- reviews: rating 내림차순, 동일 rating 시 created_at 내림차순

**TC-2.4: 별점 낮은순 정렬**
```json
{
  "page": 1,
  "size": 10,
  "sort": "rating_asc"
}
```
- Expected: 200 OK
- reviews: rating 오름차순, 동일 rating 시 created_at 내림차순

**TC-2.5: 잘못된 sort 값**
```json
{
  "page": 1,
  "size": 10,
  "sort": "invalid_sort"
}
```
- Expected: 400 Bad Request
- Error Field: `sort`
- Error Code: `Pattern`

**TC-2.6: page 범위 오류 (0 이하)**
```json
{
  "page": 0,
  "size": 10,
  "sort": "latest"
}
```
- Expected: 400 Bad Request
- Error Field: `page`
- Error Code: `Min`

**TC-2.7: size 범위 초과 (100 초과)**
```json
{
  "page": 1,
  "size": 101,
  "sort": "latest"
}
```
- Expected: 400 Bad Request
- Error Field: `size`
- Error Code: `Max`

---

### 3. 리뷰 상세 조회

**Endpoint**: `GET {{base_url}}/api/v1/reviews/{{created_review_id}}`

#### Headers
```
(없음)
```

#### Path Parameters
- `reviewId`: 조회할 리뷰 ID (Long 타입)

#### Success Response (200 OK)
```json
{
  "review_id": 1,
  "property_id": "5d41402abc4b2a76b9719d911017c592",
  "user_id": "user_1234",
  "rating": 5,
  "content": "남향이라 채광이 정말 좋고, 관리비도 저렴한 편입니다. 역세권이라 교통도 편리해요.",
  "tags": ["채광", "남향", "역세권", "편리", "교통"],
  "created_at": "2025-11-27T10:30:00",
  "updated_at": null
}
```

#### Error Responses

**400 Bad Request - 존재하지 않는 리뷰**
```json
{
  "timestamp": "2025-12-02T14:30:00.123+00:00",
  "status": 400,
  "error": "Bad Request",
  "message": "리뷰를 찾을 수 없습니다: reviewId=99999",
  "path": "/api/v1/reviews/99999"
}
```

#### Tests Script
```javascript
pm.test("Status code is 200", function () {
    pm.response.to.have.status(200);
});

pm.test("Response has full content", function () {
    var jsonData = pm.response.json();
    pm.expect(jsonData).to.have.property('review_id');
    pm.expect(jsonData).to.have.property('content');
    pm.expect(jsonData).to.have.property('tags');
    pm.expect(jsonData.tags).to.be.an('array');
});

pm.test("user_id is not masked", function () {
    var jsonData = pm.response.json();
    pm.expect(jsonData.user_id).to.not.include('****');
});
```

#### 테스트 케이스

**TC-3.1: 존재하는 리뷰 조회**
- URL: `GET {{base_url}}/api/v1/reviews/1`
- Expected: 200 OK
- userId: 마스킹 없이 원본 반환
- content: 전체 원문 반환

**TC-3.2: 존재하지 않는 리뷰 조회**
- URL: `GET {{base_url}}/api/v1/reviews/99999`
- Expected: 400 Bad Request
- Error Message: "리뷰를 찾을 수 없습니다"

---

### 4. 리뷰 수정

**Endpoint**: `POST {{base_url}}/api/v1/reviews/update`

#### Headers
```
Content-Type: application/json
```

#### Request Body
```json
{
  "review_id": {{created_review_id}},
  "rating": 4,
  "content": "살다 보니 주차 문제는 조금 있네요. 채광은 여전히 좋지만 별점 수정합니다."
}
```

#### Success Response (200 OK)
```json
{
  "review_id": 1,
  "updated_at": "2025-11-28T09:00:00"
}
```

#### Error Responses

**400 Bad Request - Validation 실패**
```json
{
  "timestamp": "2025-12-02T14:30:00.123+00:00",
  "status": 400,
  "error": "Bad Request",
  "message": "Validation failed",
  "errors": [
    {
      "defaultMessage": "별점은 1점 이상이어야 합니다",
      "field": "rating",
      "rejectedValue": 0,
      "code": "Min"
    }
  ],
  "path": "/api/v1/reviews/update"
}
```

**400 Bad Request - 존재하지 않는 리뷰**
```json
{
  "timestamp": "2025-12-02T14:30:00.123+00:00",
  "status": 400,
  "error": "Bad Request",
  "message": "리뷰를 찾을 수 없습니다: reviewId=99999",
  "path": "/api/v1/reviews/update"
}
```

#### Tests Script
```javascript
pm.test("Status code is 200", function () {
    pm.response.to.have.status(200);
});

pm.test("Response has updated_at", function () {
    var jsonData = pm.response.json();
    pm.expect(jsonData).to.have.property('review_id');
    pm.expect(jsonData).to.have.property('updated_at');
});

// 환경변수에 updated_at 저장
if (pm.response.code === 200) {
    var jsonData = pm.response.json();
    pm.environment.set("updated_at", jsonData.updated_at);
}
```

#### 테스트 케이스

**TC-4.1: 정상 수정**
```json
{
  "review_id": 1,
  "rating": 4,
  "content": "살다 보니 주차 문제는 조금 있네요. 채광은 여전히 좋지만 별점 수정합니다."
}
```
- Expected: 200 OK

**TC-4.2: review_id 누락**
```json
{
  "rating": 4,
  "content": "살다 보니 주차 문제는 조금 있네요. 채광은 여전히 좋지만 별점 수정합니다."
}
```
- Expected: 400 Bad Request
- Error Field: `reviewId`
- Error Code: `NotNull`

**TC-4.3: 존재하지 않는 review_id**
```json
{
  "review_id": 99999,
  "rating": 4,
  "content": "살다 보니 주차 문제는 조금 있네요. 채광은 여전히 좋지만 별점 수정합니다."
}
```
- Expected: 400 Bad Request
- Error Message: "리뷰를 찾을 수 없습니다"

**TC-4.4: rating 범위 초과**
```json
{
  "review_id": 1,
  "rating": 10,
  "content": "살다 보니 주차 문제는 조금 있네요. 채광은 여전히 좋지만 별점 수정합니다."
}
```
- Expected: 400 Bad Request
- Error Field: `rating`
- Error Code: `Max`

**TC-4.5: content 길이 부족**
```json
{
  "review_id": 1,
  "rating": 4,
  "content": "짧은 내용"
}
```
- Expected: 400 Bad Request
- Error Field: `content`
- Error Code: `Size`

---

### 5. 리뷰 삭제

**Endpoint**: `DELETE {{base_url}}/api/v1/reviews/{{created_review_id}}`

#### Headers
```
(없음)
```

#### Path Parameters
- `reviewId`: 삭제할 리뷰 ID (Long 타입)

#### Success Response (204 No Content)
```
(응답 Body 없음)
```

#### Error Responses

**400 Bad Request - 존재하지 않는 리뷰**
```json
{
  "timestamp": "2025-12-02T14:30:00.123+00:00",
  "status": 400,
  "error": "Bad Request",
  "message": "리뷰를 찾을 수 없습니다: reviewId=99999",
  "path": "/api/v1/reviews/99999"
}
```

#### Tests Script
```javascript
pm.test("Status code is 204", function () {
    pm.response.to.have.status(204);
});

pm.test("Response body is empty", function () {
    pm.expect(pm.response.text()).to.be.empty;
});

// 삭제 성공 시 환경변수 초기화
if (pm.response.code === 204) {
    pm.environment.unset("created_review_id");
}
```

#### 테스트 케이스

**TC-5.1: 존재하는 리뷰 삭제**
- URL: `DELETE {{base_url}}/api/v1/reviews/1`
- Expected: 204 No Content

**TC-5.2: 존재하지 않는 리뷰 삭제**
- URL: `DELETE {{base_url}}/api/v1/reviews/99999`
- Expected: 400 Bad Request
- Error Message: "리뷰를 찾을 수 없습니다"

**TC-5.3: 삭제 후 재조회**
- Precondition: TC-5.1 실행 완료
- Action: `GET {{base_url}}/api/v1/reviews/1`
- Expected: 400 Bad Request

---

## 통합 테스트 시나리오

### 시나리오 1: 기본 CRUD 플로우

| # | API | 검증 항목 |
|---|-----|----------|
| 1 | POST /api/v1/reviews | 201 Created, reviewId 반환 및 환경변수 저장 |
| 2 | POST /api/v1/reviews/query | 200 OK, 작성한 리뷰 포함 확인 |
| 3 | GET /api/v1/reviews/{id} | 200 OK, userId 마스킹 없음 확인 |
| 4 | POST /api/v1/reviews/update | 200 OK, updatedAt 반환 |
| 5 | GET /api/v1/reviews/{id} | 200 OK, 수정된 rating/content 확인 |
| 6 | DELETE /api/v1/reviews/{id} | 204 No Content |
| 7 | GET /api/v1/reviews/{id} | 400 Bad Request, "리뷰를 찾을 수 없습니다" |

### 시나리오 2: 키워드 추출 검증

| # | API | 요청 내용 | 검증 항목 |
|---|-----|----------|----------|
| 1 | POST /api/v1/reviews | content: "채광 좋고 역세권 조용한 곳입니다." | 201 Created |
| 2 | GET /api/v1/reviews/{id} | - | tags: ["채광", "역세권", "조용"] 포함 확인 |
| 3 | POST /api/v1/reviews | content: "시끄럽고 어두운 곳입니다." | 201 Created |
| 4 | GET /api/v1/reviews/{id} | - | tags: ["시끄럽", "어두운"] 포함 확인 |

### 시나리오 3: 중복 작성 방지 검증

| # | API | 요청 Body | 검증 항목 |
|---|-----|----------|----------|
| 1 | POST /api/v1/reviews | propertyId: A, userId: user1 | 201 Created |
| 2 | POST /api/v1/reviews | propertyId: A, userId: user1 (동일) | 409 Conflict |
| 3 | POST /api/v1/reviews | propertyId: A, userId: user2 (다른 사용자) | 201 Created |
| 4 | POST /api/v1/reviews | propertyId: B, userId: user1 (다른 매물) | 201 Created |

### 시나리오 4: 통계 갱신 검증

| # | API | 요청 내용 | 검증 항목 |
|---|-----|----------|----------|
| 1 | POST /api/v1/reviews | rating: 5 | 201 Created |
| 2 | POST /api/v1/reviews/query | property_id: A | avg_rating: 5.0, review_count: 1 |
| 3 | POST /api/v1/reviews | rating: 3 (동일 매물) | 201 Created |
| 4 | POST /api/v1/reviews/query | property_id: A | avg_rating: 4.0, review_count: 2 |
| 5 | POST /api/v1/reviews/update | rating: 5 → 1 | 200 OK |
| 6 | POST /api/v1/reviews/query | property_id: A | avg_rating 변경 확인 |
| 7 | DELETE /api/v1/reviews/{id} | - | 204 No Content |
| 8 | POST /api/v1/reviews/query | property_id: A | review_count 감소 확인 |

---

## Postman Collection 구조

```
Review System Tests
├── 1. Create Review
│   ├── TC-1.1 정상 리뷰 작성
│   ├── TC-1.2 propertyId 누락
│   ├── TC-1.3 propertyId 길이 오류
│   ├── TC-1.4 rating 범위 초과
│   ├── TC-1.5 rating 범위 미만
│   ├── TC-1.6 content 길이 부족
│   ├── TC-1.7 content 길이 초과
│   └── TC-1.8 중복 리뷰 작성
├── 2. Query Reviews
│   ├── TC-2.1 특정 매물 리뷰 조회
│   ├── TC-2.2 전체 리뷰 조회
│   ├── TC-2.3 별점 높은순 정렬
│   ├── TC-2.4 별점 낮은순 정렬
│   ├── TC-2.5 잘못된 sort 값
│   ├── TC-2.6 page 범위 오류
│   └── TC-2.7 size 범위 초과
├── 3. Get Review Detail
│   ├── TC-3.1 존재하는 리뷰 조회
│   └── TC-3.2 존재하지 않는 리뷰 조회
├── 4. Update Review
│   ├── TC-4.1 정상 수정
│   ├── TC-4.2 reviewId 누락
│   ├── TC-4.3 존재하지 않는 reviewId
│   ├── TC-4.4 rating 범위 초과
│   └── TC-4.5 content 길이 부족
└── 5. Delete Review
    ├── TC-5.1 존재하는 리뷰 삭제
    ├── TC-5.2 존재하지 않는 리뷰 삭제
    └── TC-5.3 삭제 후 재조회
```

---

## 테스트용 샘플 데이터

### Property IDs (32자 MD5 Hash)
```
5d41402abc4b2a76b9719d911017c592  # 테스트 매물 1
e99a18c428cb38d5f260853678922e03  # 테스트 매물 2
d8578edf8458ce06fbc5bb76a58c5ca4  # 테스트 매물 3
```

### User IDs
```
user_1234
user_5678
user_test_001
```

### 키워드 추출 테스트용 Content
```
긍정: "남향이라 채광이 좋고 조용한 역세권 아파트입니다. 관리도 잘 되어있고 깨끗합니다."
부정: "북향이라 어둡고 시끄러운 곳입니다. 관리가 안 되어 노후되었습니다."
혼합: "채광은 좋지만 주차가 불편하고 소음이 있습니다."
```

---

## 주의사항

1. **Base URL 확인**: 실제 코드는 `8185` 포트를 사용하나, 환경에 따라 변경 필요
2. **DB 초기화**: 중복 테스트 방지를 위해 각 시나리오 전 DB 초기화 권장
3. **Unique Constraint**: REVIEWS 테이블의 `UK_REVIEWS_PROPERTY_USER` 제약조건으로 인해 동일 (propertyId, userId) 조합은 1건만 저장 가능
4. **키워드 추출**: KeywordExtractor는 KeywordDictionary의 정적 키워드 목록 기반으로 동작
5. **통계 재산출**: 리뷰 작성/수정/삭제 시 ReviewStatistics 테이블이 실시간 갱신됨