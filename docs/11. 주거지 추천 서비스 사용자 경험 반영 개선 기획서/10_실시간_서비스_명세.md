## 10. 실시간 서비스 명세 (Real-time Service Specification)

### 10.1 개요 (Overview)

#### 10.1.1 목적 (Purpose)

본 서비스 명세는 사용자의 주거 조건(예산, 평수, 지역)과 우선순위(가격, 안전, 공간)를 입력받아 최적의 매물을 실시간으로 추천하는 **하이브리드 추천 엔진(Hybrid Recommendation Engine)**의 로직을 정의한다.

기존의 검증된 정량적 분석 로직(공공데이터 기반)을 훼손하지 않으면서, 실거주자의 정성적 경험 데이터(리뷰 평점 및 키워드)를 **동등한 비중(50:50)**으로 통합하여 추천 결과의 신뢰도와 사용자 만족도를 극대화하는 것을 목표로 한다. 또한, Redis 파이프라인(Pipeline) 기술을 도입하여 데이터 조회 복잡도 증가에도 불구하고 밀리초(ms) 단위의 응답 속도를 보장한다.

#### 10.1.2 서비스 범위 및 책임 (Scope & Responsibility)

* **입력 처리**: `CharterRecommendationRequestDto` 및 `MonthlyRecommendationRequestDto`를 통해 사용자의 검색 조건과 우선순위 가중치를 수신한다.
* **검색 및 필터링**: Redis의 정렬된 인덱스(Sorted Set)를 활용하여 조건에 부합하는 후보 매물군을 1차적으로 선별하고, 매물 부족 시 자동 완화(Fallback) 로직을 수행한다.
* **데이터 조회**: 선별된 후보 매물에 대해 매물 상세 정보와 리뷰 통계 정보를 Redis에서 병렬로 조회한다.
* **점수 산출 (Scoring)**: 공공데이터 기반의 기존 점수(50%)와 리뷰 기반의 신규 점수(50%)를 가중 합산하여 최종 랭킹을 산정한다.
* **응답 반환**: 최종 순위가 결정된 지역구 및 매물 리스트를 클라이언트가 요구하는 포맷(String ID 포함)으로 변환하여 반환한다.

#### 10.1.3 AS-IS vs TO-BE 비교 (Key Changes)

본 고도화 프로젝트는 기존 시스템의 검증된 로직을 기반으로 하되, 리뷰 데이터 통합을 위한 조회 대상 확장과 점수 산출 로직의 고도화에 중점을 둔다.

| 구분 | AS-IS (기존 시스템) | TO-BE (고도화 시스템) | 비고 |
|------|---------------------|---------------------|------|
| **검색 로직** | **인덱스 교집합 기반 검색**<br/><br/>사용자의 검색 조건에 따라 Redis Sorted Set 인덱스(가격, 평수, 지역) 간의 교집합 연산을 수행하며, 결과가 부족할 경우 2단계에 걸쳐 조건을 완화하는 폴백(Fallback) 로직을 수행한다. | **[유지] 기존 로직 100% 재사용**<br/><br/>이미 검증된 검색 성능과 시스템 안정성을 확보하기 위해, 매물 후보군을 추출하는 1차 검색 및 폴백 프로세스는 변경 없이 기존 로직을 그대로 계승한다. | 변경 없음 |
| **데이터 조회** | **단일 도메인 파이프라인 조회**<br/><br/>`Redis Pipeline`을 사용하여 검색된 매물 ID 리스트에 해당하는 매물 상세 정보(`property:*`)만을 조회한다. | **단계별 데이터 조회 (Phased Retrieval)**<br/><br/>Phase 1에서는 기존과 동일하게 매물 정보(`property:*`)만 조회하여 정량 점수를 산출한다. Phase 2에서는 리뷰 통계(`stats:*`)를 별도 Pipeline으로 조회하여 정성 점수를 산출한 후 통합한다. 이를 통해 기존 로직의 안정성을 보존하면서 리뷰 데이터를 비침해적으로 확장한다. | 로직 확장 (비침해적) |
| **점수 산출** | **정량적 단일 평가**<br/><br/>가격, 평수, 안전성 세 가지 정량적 지표만을 사용하여 점수를 산출하며, 이를 100% 비중으로 반영한 `LegacyScore`를 최종 점수로 사용한다. | **하이브리드 복합 평가**<br/><br/>공공데이터 기반의 정량 점수(50%)와 사용자 리뷰 기반의 정성 점수(50%)를 가중 합산한다. 단, 리뷰 개수가 5개 미만인 경우 등 통계적 유의성이 부족한 경우 리뷰 점수를 배제하고 정량 점수만을 100% 반영한다. | 알고리즘 고도화 |
| **데이터 타입/ID 체계** | **Long ID 체계**<br/><br/>매물 식별자(`propertyId`)가 숫자형(Long)으로 정의되어 있으며, 배치 실행 시마다 UUID 기반으로 새로운 ID가 생성되는 휘발성 구조를 가진다. | **String ID 체계**<br/><br/>매물 식별자 32자 길이의 문자열(String)로 변경된다. 불변 속성을 조합한 MD5 Hash 값을 직접적에 데이터의 영속성을 보장하며, 이에 따라 API 응답 명세의 타입 변경이 수반된다. | API 명세 변경<br/>(Breaking Change) |

---

### 10.2 상세 프로세스 명세 (Detailed Process Specification)

#### 10.2.1 전세 추천 서비스 (CharterRecommendationService)

본 서비스의 로직은 **기존 시스템의 안정성을 보장하는 검색 단계(Phase 1)**와 **리뷰 데이터를 통합하여 가치를 창출하는 점수 산출 단계(Phase 2)**로 명확히 구분되어 순차적으로 실행된다.

##### Phase 1: 기존 로직 기반 후보군 추출 및 기본 점수 산출

Phase 1은 기존 시스템의 검증된 로직을 100% 재사용하여 매물 후보군을 확보하고, 공공데이터 기반의 정량적 점수를 산출하는 단계이다.

| 기능 ID | 기능명 | 상세 구현 내용 |
|---------|--------|----------------|
| C-01 | 전세 전 지역구 1차 검색 (Strict) | 1. 서울시 25개 자치구를 모두 순회한다.<br/>2. 안전성 조건이 있을 경우 지역구 레벨에서 사전 필터링을 적용한다.<br/>3. 각 자치구마다 2개 인덱스 교집합을 수행한다: `idx:charterPrice:{지역구}` + `idx:area:{지역구}:전세`<br/>4. 전세금과 평수 조건을 모두 만족하는 매물들의 교집합을 구하여, 각 자치구별 유효 매물을 생성한다. |
| C-02 | 전세 폴백(Fallback) 조건 판단 | 1. C-01에서 생성된 지역구별 매물 중 3개 미만인 지역구가 있는지 검사한다.<br/>2. 부족한 지역구가 있을 경우, C-03 확장 검색을 실행한다.<br/>3. 모든 지역구가 충족될 경우, C-04 점수 계산으로 넘어간다. |
| C-03 | 전세 2차 확장 검색 (Expanded) | 1. 매물이 부족한 지역구들만 추출한다.<br/>2. 사용자의 3순위 조건을 완화하여 부족한 지역구들만 재검색한다.<br/>3. 여전히 부족하면 2순위 조건까지 완화하여 재검색한다.<br/>4. 완화된 조건 정보를 응답 메시지에 포함한다. |
| C-04 | 전세 매물 단위 점수 계산 | 1. Redis에서 `property:charter:{id}` 패턴으로 매물 상세 정보를 Pipeline 조회한다.<br/>2. `bounds:{지역구}:전세` 키에서 정규화 범위를 조회한다.<br/>3. 전세금 점수(낮을수록 높은 점수), 평수 점수(넓을수록 높은 점수), 안전 점수를 각각 0~100점으로 계산한다.<br/>4. 우선순위별 60%/30%/10% 가중치를 적용하여 최종 점수를 산출한다.<br/>5. 각 지역구 내에서 매물을 최종 점수 기준으로 내림차순 정렬한다. |
| C-05 | 전세 지역구 단위 점수 계산 | 1. 각 지역구의 대표 점수를 산출한다: `평균 finalScore × log(매물 개수 + 1)` |

**Phase 1 종료 및 Phase 2 전환점**

Phase 1은 C-05의 지역구별 대표 점수 산출까지 수행된다. 기존 시스템에서는 이 대표 점수를 기준으로 지역구를 정렬하고 최종 응답을 생성했으나, 고도화 시스템에서는 **C-05의 2번 단계(대표 점수 기준 지역구 정렬) 이후부터 Phase 2(하이브리드 점수 통합)로 대체**된다.

즉, 기존 로직의 다음 단계들은 Phase 2에서 리뷰 점수가 통합된 새로운 로직으로 재구성된다: