# 데이터 정합성 보장을 위한 트랜잭션 격리 및 동시성 제어 전략

문서 번호: SPEC-TECH-TRX-001  
작성 일자: 2025-11-26  
관련 모듈: ReviewService, StatisticsModule  
적용 기술: Oracle RDBMS (Undo/Redo), Pessimistic Locking

## 1. 개요 (Overview)

본 문서는 주거지 추천 서비스의 핵심 기능인 '리뷰 작성' 및 '통계 갱신' 과정에서 발생할 수 있는 **동시성 문제(Concurrency Issues)**를 정의하고, 이를 해결하기 위한 데이터베이스 레벨의 물리적 제어 방식을 실험을 통해 검증 및 확정한 기술 명세다.

## 2. 문제 정의: 동시성 아노말리 (Concurrency Anomaly)

다수의 사용자가 동시에 리뷰를 작성할 경우, `ReviewStatistics` 테이블(평점, 리뷰 수)에 대해 다음과 같은 물리적 충돌이 발생할 수 있다.

1. Dirty Read: 아직 커밋되지 않은(작성 중인) 통계 데이터를 타 사용자가 조회하여 잘못된 평점을 인지하는 현상.
2. Lost Update (갱신 손실): 사용자 A와 B가 동시에 평점을 갱신할 때, A의 업데이트 내용이 B에 의해 덮어씌워져 유실되는 현상.

## 3. 검증 실험 및 아키텍처 결정 (Verification & Decision)

### 3.1 읽기 일관성 (Read Consistency) 검증

* 실험 내용: 트랜잭션 A가 데이터를 수정 중일 때, 트랜잭션 B가 해당 데이터를 조회.
* 관측 결과:
   * 트랜잭션 A: 수정된 값(`5.0`) 조회됨 (Current Read).
   * 트랜잭션 B: 수정 전 값(`4.4`) 조회됨 (Consistent Read).
* 기술적 원리: 오라클의 Undo Log를 활용한 MVCC 메커니즘이 작동하여, 락(Lock) 없이도 Dirty Read를 방지함을 확인.
* 설계 결정: 조회(Read) 로직에는 별도의 락을 걸지 않고, DB 엔진의 기본 격리 수준(Read Committed)을 따른다.

### 3.2 쓰기 제어 (Write Control) 검증

* 실험 내용: 트랜잭션 A가 데이터를 수정하고 커밋하지 않은 상태에서, 트랜잭션 B가 동일 데이터 수정을 시도.
* 관측 결과:
   * 트랜잭션 B의 쿼리가 즉시 실행되지 않고 멈춤(Blocking) 현상 발생.
   * 트랜잭션 A가 `COMMIT` 하는 순간 트랜잭션 B가 재개됨.
   * 대기 시간: 31.308초 (실험 데이터).
* 기술적 원리: **Row-Level Exclusive Lock(TX Lock)**에 의해 후행 트랜잭션이 대기 큐(Wait Queue)에서 물리적으로 직렬화(Serialization)됨.
* 설계 결정:
   * 통계 데이터의 정합성이 필수적인 로직에는 **비관적 락(Pessimistic Lock)**을 적용한다.
   * 단, 무한 대기(Infinite Blocking)를 방지하기 위해 애플리케이션 레벨에서 `NOWAIT` 또는 `TIMEOUT` 설정을 필수적으로 적용한다.

## 4. 애플리케이션 구현 전략 (Implementation Strategy)

검증된 DB 내부 동작을 Spring Boot 애플리케이션에 적용하기 위해 다음과 같은 JPA 구현 전략을 수립한다.

### 4.1 비관적 락 적용 코드 (Example)

```java
public interface ReviewStatisticsRepository extends JpaRepository<ReviewStatistics, Long> {

    @Lock(LockModeType.PESSIMISTIC_WRITE) // DB 레벨의 'SELECT ... FOR UPDATE' 발생
    @QueryHints({@QueryHint(name = "javax.persistence.lock.timeout", value = "3000")}) // 3초 타임아웃
    @Query("select s from ReviewStatistics s where s.propertyId = :propertyId")
    Optional<ReviewStatistics> findByPropertyIdWithLock(@Param("propertyId") Long propertyId);
}
```

### 4.2 예외 처리 정책

* LockTimeoutException: 3초 이내에 락을 획득하지 못할 경우, 사용자에게 "현재 서버가 혼잡합니다"라는 메시지와 함께 재시도(Retry)를 요청하거나, 큐잉 시스템으로 위임한다.