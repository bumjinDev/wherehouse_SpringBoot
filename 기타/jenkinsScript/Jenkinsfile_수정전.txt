// Jenkinsfile - ê°œì„ ëœ ë²„ì „
pipeline {
    agent any

    tools {
        jdk 'JDK17'
        gradle 'Gradle-latest'
    }

    environment {
        MOLIT_RENT_API_SERVICE_KEY = credentials('molit-api-key')
        JWT_SECRET_KEY = credentials('jwt-secret-key')
        
        // ë°°í¬ ì„œë²„ ì •ë³´
        DEPLOY_USER = 'root'
        DEPLOY_SERVER = '43.202.178.156'
        TOMCAT_HOME = '/opt/tomcat'
        APP_NAME = 'wherehouse'
        WAR_FILE = 'wherehouse.war'
    }

    options {
        timeout(time: 30, unit: 'MINUTES')
        retry(1)
        timestamps()
    }

    stages {
        // 1. Git ì†ŒìŠ¤ ì½”ë“œ ë³µì œ
        stage('Git Clone') {
            steps {
                script {
                    echo "=== Git Clone ì‹œì‘ ==="
                    // ì‘ì—…ê³µê°„ ì •ë¦¬
                    cleanWs()
                    
                    git branch: 'master', 
                        url: 'https://github.com/bumjinDev/wherehouse_SpringBoot.git',
                        credentialsId: 'github-credentials' // GitHub credentials ì„¤ì • í•„ìš”ì‹œ
                    
                    echo "=== Git Clone ì™„ë£Œ ==="
                }
            }
        }

        // 2. ë¹Œë“œ í™˜ê²½ ì„¤ì • ë° ê¶Œí•œ ë¶€ì—¬
        stage('Setup Build Environment') {
            steps {
                script {
                    echo "=== ë¹Œë“œ í™˜ê²½ ì„¤ì • ì‹œì‘ ==="
                    dir('wherehouse') {
                        // gradlew íŒŒì¼ ì¡´ì¬ í™•ì¸
                        if (!fileExists('./gradlew')) {
                            error "gradlew íŒŒì¼ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤."
                        }
                        
                        // gradlew ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬
                        sh 'chmod +x ./gradlew'
                        
                        // Gradle ë²„ì „ í™•ì¸
                        sh './gradlew --version'
                        
                        echo "=== ë¹Œë“œ í™˜ê²½ ì„¤ì • ì™„ë£Œ ==="
                    }
                }
            }
        }

        // 3. ì˜ì¡´ì„± ë‹¤ìš´ë¡œë“œ ë° ì»´íŒŒì¼ í…ŒìŠ¤íŠ¸
        stage('Dependencies & Compile Test') {
            steps {
                script {
                    echo "=== ì˜ì¡´ì„± ê²€ì‚¬ ë° ì»´íŒŒì¼ í…ŒìŠ¤íŠ¸ ì‹œì‘ ==="
                    dir('wherehouse') {
                        try {
                            // ì˜ì¡´ì„± ë‹¤ìš´ë¡œë“œ
                            sh './gradlew dependencies'
                            
                            // ì»´íŒŒì¼ í…ŒìŠ¤íŠ¸
                            sh './gradlew compileJava'
                            
                            echo "=== ì˜ì¡´ì„± ê²€ì‚¬ ë° ì»´íŒŒì¼ í…ŒìŠ¤íŠ¸ ì™„ë£Œ ==="
                        } catch (Exception e) {
                            error "ì˜ì¡´ì„± ë˜ëŠ” ì»´íŒŒì¼ ì˜¤ë¥˜: ${e.getMessage()}"
                        }
                    }
                }
            }
        }

        // 4. WAR íŒŒì¼ ë¹Œë“œ
        stage('Build WAR') {
            steps {
                script {
                    echo "=== WAR íŒŒì¼ ë¹Œë“œ ì‹œì‘ ==="
                    dir('wherehouse') {
                        try {
                            // ì´ì „ ë¹Œë“œ ê²°ê³¼ë¬¼ ì •ë¦¬
                            sh './gradlew clean'
                            
                            // WAR íŒŒì¼ ë¹Œë“œ
                            sh './gradlew bootWar'
                            
                            // ë¹Œë“œ ê²°ê³¼ í™•ì¸
                            if (!fileExists("build/libs/${env.WAR_FILE}")) {
                                error "WAR íŒŒì¼ ë¹Œë“œê°€ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤."
                            }
                            
                            // WAR íŒŒì¼ í¬ê¸° í™•ì¸
                            sh "ls -lah build/libs/${env.WAR_FILE}"
                            
                            echo "=== WAR íŒŒì¼ ë¹Œë“œ ì™„ë£Œ ==="
                        } catch (Exception e) {
                            error "WAR ë¹Œë“œ ì˜¤ë¥˜: ${e.getMessage()}"
                        }
                    }
                }
            }
        }

        // 5. ë°°í¬ ì „ ì„œë²„ ì—°ê²° í…ŒìŠ¤íŠ¸
        stage('Pre-Deploy Server Check') {
            steps {
                script {
                    echo "=== ë°°í¬ ì„œë²„ ì—°ê²° í…ŒìŠ¤íŠ¸ ì‹œì‘ ==="
                    try {
                        // SSH ì—°ê²° í…ŒìŠ¤íŠ¸
                        sh """
                            ssh -o ConnectTimeout=10 -o StrictHostKeyChecking=no \
                            ${env.DEPLOY_USER}@${env.DEPLOY_SERVER} 'echo "SSH ì—°ê²° ì„±ê³µ"'
                        """
                        
                        // í†°ìº£ ë””ë ‰í† ë¦¬ ì¡´ì¬ í™•ì¸
                        sh """
                            ssh -o StrictHostKeyChecking=no \
                            ${env.DEPLOY_USER}@${env.DEPLOY_SERVER} \
                            'test -d ${env.TOMCAT_HOME} && echo "í†°ìº£ ë””ë ‰í† ë¦¬ í™•ì¸ë¨" || exit 1'
                        """
                        
                        echo "=== ë°°í¬ ì„œë²„ ì—°ê²° í…ŒìŠ¤íŠ¸ ì™„ë£Œ ==="
                    } catch (Exception e) {
                        error "ì„œë²„ ì—°ê²° í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨: ${e.getMessage()}"
                    }
                }
            }
        }

        // 6. ì• í”Œë¦¬ì¼€ì´ì…˜ ë°°í¬
        stage('Deploy Application') {
            steps {
                script {
                    echo "=== ì• í”Œë¦¬ì¼€ì´ì…˜ ë°°í¬ ì‹œì‘ ==="
                    try {
                        // WAR íŒŒì¼ ì¡´ì¬ í™•ì¸
                        if (!fileExists("wherehouse/build/libs/${env.WAR_FILE}")) {
                            error "WAR íŒŒì¼ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤: wherehouse/build/libs/${env.WAR_FILE}"
                        }
                        
                        // WAR íŒŒì¼ì„ ë°°í¬ ì„œë²„ë¡œ ë³µì‚¬
                        sh """
                            echo "WAR íŒŒì¼ ë³µì‚¬ ì¤‘: wherehouse/build/libs/${env.WAR_FILE}"
                            ls -la wherehouse/build/libs/${env.WAR_FILE}
                            
                            scp -v -o StrictHostKeyChecking=no \
                            wherehouse/build/libs/${env.WAR_FILE} \
                            ${env.DEPLOY_USER}@${env.DEPLOY_SERVER}:${env.TOMCAT_HOME}/webapps/
                            
                            echo "WAR íŒŒì¼ ë³µì‚¬ ì™„ë£Œ"
                        """
                        
                        // ë³µì‚¬ ê²°ê³¼ í™•ì¸
                        sh """
                            ssh -o StrictHostKeyChecking=no \
                            ${env.DEPLOY_USER}@${env.DEPLOY_SERVER} \
                            'ls -la ${env.TOMCAT_HOME}/webapps/${env.WAR_FILE} && echo "WAR íŒŒì¼ ë³µì‚¬ í™•ì¸ë¨"'
                        """
                        
                        // ì›ê²© ì„œë²„ì—ì„œ ë°°í¬ ì‹¤í–‰
                        sh """
                            ssh -o StrictHostKeyChecking=no \
                            ${env.DEPLOY_USER}@${env.DEPLOY_SERVER} << 'DEPLOY_SCRIPT'

                            set -e  # ì˜¤ë¥˜ ë°œìƒ ì‹œ ìŠ¤í¬ë¦½íŠ¸ ì¤‘ë‹¨

                            echo "=== ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ ì‹œì‘ ==="

                            # í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
                            TOMCAT_HOME="${env.TOMCAT_HOME}"
                            APP_NAME="${env.APP_NAME}"
                            WAR_FILE="${env.WAR_FILE}"
                            TIMESTAMP=\$(date +'%Y%m%d_%H%M%S')

                            # 1. í˜„ì¬ ì‹¤í–‰ ì¤‘ì¸ í†°ìº£ í”„ë¡œì„¸ìŠ¤ í™•ì¸ ë° ì¤‘ì§€
                            echo "í˜„ì¬ í†°ìº£ í”„ë¡œì„¸ìŠ¤ í™•ì¸ ì¤‘..."
                            TOMCAT_PID=\$(ps -ef | grep "\$TOMCAT_HOME" | grep -v grep | awk '{print \$2}' | head -1)
                            
                            if [ -n "\$TOMCAT_PID" ]; then
                                echo "í†°ìº£ í”„ë¡œì„¸ìŠ¤ \$TOMCAT_PID ì¢…ë£Œ ì¤‘..."
                                kill -TERM \$TOMCAT_PID
                                
                                # Graceful shutdown ëŒ€ê¸° (ìµœëŒ€ 30ì´ˆ)
                                for i in \$(seq 1 30); do
                                    if ! kill -0 \$TOMCAT_PID 2>/dev/null; then
                                        echo "í†°ìº£ì´ ì •ìƒì ìœ¼ë¡œ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤."
                                        break
                                    fi
                                    if [ \$i -eq 30 ]; then
                                        echo "ê°•ì œ ì¢…ë£Œí•©ë‹ˆë‹¤..."
                                        kill -9 \$TOMCAT_PID
                                    fi
                                    sleep 1
                                done
                            else
                                echo "ì‹¤í–‰ ì¤‘ì¸ í†°ìº£ í”„ë¡œì„¸ìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤."
                            fi

                            # 2. ê¸°ì¡´ ì• í”Œë¦¬ì¼€ì´ì…˜ ë°±ì—…
                            if [ -d "\$TOMCAT_HOME/webapps/\$APP_NAME" ]; then
                                echo "ê¸°ì¡´ ì• í”Œë¦¬ì¼€ì´ì…˜ ë°±ì—… ì¤‘..."
                                mv "\$TOMCAT_HOME/webapps/\$APP_NAME" "\$TOMCAT_HOME/webapps/\${APP_NAME}_backup_\$TIMESTAMP"
                            fi

                            # 3. ìƒˆ WAR íŒŒì¼ ì¡´ì¬ í™•ì¸
                            echo "ìƒˆ WAR íŒŒì¼ ì¡´ì¬ í™•ì¸ ì¤‘..."
                            if [ ! -f "\$TOMCAT_HOME/webapps/\$WAR_FILE" ]; then
                                echo "ì˜¤ë¥˜: ìƒˆ WAR íŒŒì¼ì´ ë³µì‚¬ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤: \$TOMCAT_HOME/webapps/\$WAR_FILE"
                                ls -la "\$TOMCAT_HOME/webapps/"
                                exit 1
                            fi
                            
                            echo "ìƒˆ WAR íŒŒì¼ ì •ë³´:"
                            ls -la "\$TOMCAT_HOME/webapps/\$WAR_FILE"

                            # 4. ê¸°ì¡´ WAR íŒŒì¼ì„ ë°±ì—…ìœ¼ë¡œ ë³µì‚¬ (ì´ë™ì´ ì•„ë‹Œ ë³µì‚¬)
                            if [ -f "\$TOMCAT_HOME/webapps/\$WAR_FILE" ]; then
                                echo "ê¸°ì¡´ WAR íŒŒì¼ì„ ë°±ì—…ìœ¼ë¡œ ë³µì‚¬ ì¤‘..."
                                cp "\$TOMCAT_HOME/webapps/\$WAR_FILE" "\$TOMCAT_HOME/webapps/\${WAR_FILE}.backup_\$TIMESTAMP"
                            fi

                            # 5. WAR íŒŒì¼ ê¶Œí•œ ì„¤ì •
                            echo "WAR íŒŒì¼ ê¶Œí•œ ì„¤ì • ì¤‘..."
                            chown tomcat:tomcat "\$TOMCAT_HOME/webapps/\$WAR_FILE"
                            chmod 755 "\$TOMCAT_HOME/webapps/\$WAR_FILE"
                            ls -la "\$TOMCAT_HOME/webapps/\$WAR_FILE"

                            # 6. í†°ìº£ ë¡œê·¸ ë””ë ‰í† ë¦¬ ê¶Œí•œ í™•ì¸
                            if [ -d "\$TOMCAT_HOME/logs" ]; then
                                chown -R tomcat:tomcat "\$TOMCAT_HOME/logs"
                            fi

                            # 7. í†°ìº£ ì¬ì‹œì‘
                            echo "í†°ìº£ ì‹œì‘ ì¤‘..."
                            sudo -u tomcat "\$TOMCAT_HOME/bin/startup.sh"

                            # 8. í†°ìº£ ì‹œì‘ í™•ì¸ (ìµœëŒ€ 2ë¶„ ëŒ€ê¸°)
                            echo "í†°ìº£ ì‹œì‘ í™•ì¸ ì¤‘..."
                            for i in \$(seq 1 120); do
                                if [ -f "\$TOMCAT_HOME/logs/catalina.out" ]; then
                                    if grep -q "Server startup in" "\$TOMCAT_HOME/logs/catalina.out" 2>/dev/null; then
                                        echo "í†°ìº£ì´ ì„±ê³µì ìœ¼ë¡œ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤."
                                        break
                                    fi
                                fi
                                
                                if [ \$i -eq 120 ]; then
                                    echo "ê²½ê³ : í†°ìº£ ì‹œì‘ í™•ì¸ ì‹œê°„ì´ ì´ˆê³¼ë˜ì—ˆìŠµë‹ˆë‹¤."
                                    echo "í†°ìº£ ë¡œê·¸ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”:"
                                    tail -n 20 "\$TOMCAT_HOME/logs/catalina.out" 2>/dev/null || echo "ë¡œê·¸ íŒŒì¼ì„ ì½ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
                                fi
                                sleep 1
                            done

                            # 9. ì• í”Œë¦¬ì¼€ì´ì…˜ ë°°í¬ í™•ì¸
                            sleep 10
                            if [ -d "\$TOMCAT_HOME/webapps/\$APP_NAME" ]; then
                                echo "ì• í”Œë¦¬ì¼€ì´ì…˜ì´ ì„±ê³µì ìœ¼ë¡œ ë°°í¬ë˜ì—ˆìŠµë‹ˆë‹¤."
                            else
                                echo "ê²½ê³ : ì• í”Œë¦¬ì¼€ì´ì…˜ ë””ë ‰í† ë¦¬ê°€ ìƒì„±ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."
                            fi

                            # 10. ì´ì „ ë°±ì—… íŒŒì¼ ì •ë¦¬ (7ì¼ ì´ì „ íŒŒì¼ë§Œ ìœ ì§€)
                            echo "ì´ì „ ë°±ì—… íŒŒì¼ ì •ë¦¬ ì¤‘..."
                            find "\$TOMCAT_HOME/webapps/" -name "*backup_*" -mtime +7 -delete 2>/dev/null || true

                            echo "=== ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ ì™„ë£Œ ==="

DEPLOY_SCRIPT
                        """
                        
                        echo "=== ì• í”Œë¦¬ì¼€ì´ì…˜ ë°°í¬ ì™„ë£Œ ==="
                    } catch (Exception e) {
                        error "ë°°í¬ ì‹¤íŒ¨: ${e.getMessage()}"
                    }
                }
            }
        }

        // 7. ë°°í¬ í›„ í—¬ìŠ¤ ì²´í¬
        stage('Health Check') {
            steps {
                script {
                    echo "=== ì• í”Œë¦¬ì¼€ì´ì…˜ í—¬ìŠ¤ ì²´í¬ ì‹œì‘ ==="
                    try {
                        // 30ì´ˆ ëŒ€ê¸° í›„ í—¬ìŠ¤ ì²´í¬ ì‹œì‘
                        sleep(30)
                        
                        // ê¸°ë³¸ ì—°ê²° í…ŒìŠ¤íŠ¸ (í¬íŠ¸ 8080 ë˜ëŠ” ì„¤ì •ëœ í¬íŠ¸)
                        sh """
                            ssh -o StrictHostKeyChecking=no \
                            ${env.DEPLOY_USER}@${env.DEPLOY_SERVER} \
                            'netstat -tlnp | grep :8080 && echo "í†°ìº£ í¬íŠ¸ í™•ì¸ë¨"'
                        """
                        
                        // ì• í”Œë¦¬ì¼€ì´ì…˜ ë””ë ‰í† ë¦¬ í™•ì¸
                        sh """
                            ssh -o StrictHostKeyChecking=no \
                            ${env.DEPLOY_USER}@${env.DEPLOY_SERVER} \
                            'ls -la ${env.TOMCAT_HOME}/webapps/${env.APP_NAME}/ | head -5'
                        """
                        
                        echo "=== ì• í”Œë¦¬ì¼€ì´ì…˜ í—¬ìŠ¤ ì²´í¬ ì™„ë£Œ ==="
                    } catch (Exception e) {
                        // í—¬ìŠ¤ ì²´í¬ ì‹¤íŒ¨ëŠ” ê²½ê³ ë¡œ ì²˜ë¦¬í•˜ê³  ê³„ì† ì§„í–‰
                        echo "ê²½ê³ : í—¬ìŠ¤ ì²´í¬ ì‹¤íŒ¨ - ${e.getMessage()}"
                        echo "ìˆ˜ë™ìœ¼ë¡œ ì• í”Œë¦¬ì¼€ì´ì…˜ ìƒíƒœë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”."
                    }
                }
            }
        }
    }

    post {
        always {
            echo "=== íŒŒì´í”„ë¼ì¸ ì‹¤í–‰ ì™„ë£Œ ==="
            
            // ë¹Œë“œ ê²°ê³¼ë¬¼ ì•„ì¹´ì´ë¸Œ (ì„ íƒì‚¬í•­)
            script {
                if (fileExists('wherehouse/build/libs/wherehouse.war')) {
                    archiveArtifacts artifacts: 'wherehouse/build/libs/*.war', 
                                   fingerprint: true,
                                   allowEmptyArchive: false
                }
            }
        }
        
        success {
            echo "ğŸ‰ ë°°í¬ê°€ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!"
            echo "ì• í”Œë¦¬ì¼€ì´ì…˜ URL: http://${env.DEPLOY_SERVER}:8080/${env.APP_NAME}"
            
            // ì„±ê³µ ì•Œë¦¼ (ì„ íƒì‚¬í•­ - Slack, ì´ë©”ì¼ ë“±)
            // slackSend channel: '#deploy', 
            //           color: 'good', 
            //           message: "âœ… ${env.JOB_NAME} - ${env.BUILD_NUMBER} ë°°í¬ ì„±ê³µ"
        }
        
        failure {
            echo "âŒ ë°°í¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤."
            echo "ë¹Œë“œ ë¡œê·¸ë¥¼ í™•ì¸í•˜ì—¬ ë¬¸ì œë¥¼ í•´ê²°í•´ì£¼ì„¸ìš”."
            
            // ì‹¤íŒ¨ ì•Œë¦¼ (ì„ íƒì‚¬í•­)
            // slackSend channel: '#deploy', 
            //           color: 'danger', 
            //           message: "âŒ ${env.JOB_NAME} - ${env.BUILD_NUMBER} ë°°í¬ ì‹¤íŒ¨"
        }
        
        cleanup {
            script {
                echo "=== íŒŒì´í”„ë¼ì¸ ì •ë¦¬ ì‘ì—… ì‹œì‘ ==="
                // ì‘ì—…ê³µê°„ ì •ë¦¬ (í•„ìš”ì‹œ ì£¼ì„ í•´ì œ)
                // cleanWs()
                echo "=== íŒŒì´í”„ë¼ì¸ ì •ë¦¬ ì‘ì—… ì™„ë£Œ ==="
            }
        }
    }
}